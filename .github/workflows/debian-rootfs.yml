name: Build Debian RootFS for Xiaomi Raphael

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: '内核版本 (对应Release标签，如6.18)'
        required: true
        default: '6.18'
      skip_release:
        description: '跳过创建GitHub Release'
        required: false
        type: boolean
        default: false
      test_mode:
        description: '测试模式 (仅构建debian-server)'
        required: false
        type: boolean
        default: false
      use_china_mirror:
        description: '使用中国源'
        required: false
        type: boolean
        default: true

env:
  DEFAULT_KERNEL: '6.18'

jobs:
  setup:
    name: "环境准备"
    runs-on: ubuntu-24.04-arm
    outputs:
      kernel_version: ${{ steps.get_kernel_version.outputs.kernel_version }}
      distro_matrix: ${{ steps.generate_matrix.outputs.distro_matrix }}
    
    steps:
    - name: "检出代码"
      uses: actions/checkout@v4
    
    - name: "确定内核版本"
      id: get_kernel_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.kernel_version }}" ]]; then
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
        elif [[ "${{ github.ref_type }}" == "tag" ]]; then
          KERNEL_VER="${GITHUB_REF#refs/tags/}"
        else
          KERNEL_VER="${{ env.DEFAULT_KERNEL }}"
        fi
        
        if [[ ! "$KERNEL_VER" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
          echo "错误：内核版本格式无效: $KERNEL_VER"
          exit 1
        fi
        
        echo "kernel_version=$KERNEL_VER" >> $GITHUB_OUTPUT
    
    - name: "生成发行版矩阵"
      id: generate_matrix
      run: |
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          DISTRO_MATRIX='["debian-server"]'
        else
          DISTRO_MATRIX='["debian-server", "debian-desktop"]'
        fi
        echo "distro_matrix=$DISTRO_MATRIX" >> $GITHUB_OUTPUT

  build-rootfs:
    name: "构建 - ${{ matrix.distro }}"
    runs-on: ubuntu-24.04-arm
    needs: setup
    strategy:
      matrix:
        distro: ${{ fromJson(needs.setup.outputs.distro_matrix) }}
      fail-fast: false
    
    steps:
    - name: "检出代码"
      uses: actions/checkout@v4
    
    - name: "安装构建工具"
      run: |
        sudo apt-get update
        sudo apt-get install -y debootstrap p7zip-full curl
    
    - name: "下载内核包"
      id: download_kernel
      run: |
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        RELEASE_TAG="kernel-$KERNEL_VER"
        
        echo "从Release [$RELEASE_TAG] 下载内核包..."
        
        if ! gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
          echo "错误：找不到Release [$RELEASE_TAG]"
          exit 1
        fi
        
        gh release download "$RELEASE_TAG" \
          --pattern "*-xiaomi-raphael*.deb" \
          --repo "${{ github.repository }}" \
          --clobber
        
        DEB_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        if [ "$DEB_COUNT" -eq 0 ]; then
          echo "错误：未下载到任何内核包！"
          exit 1
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: "执行RootFS构建"
      id: build_rootfs
      timeout-minutes: 120
      run: |
        DISTRO="${{ matrix.distro }}"
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        
        # 查找构建脚本
        for script in build-rootfs.sh debian-rootfs_build.sh build.sh; do
          if [ -f "$script" ]; then
            BUILD_SCRIPT="$script"
            break
          fi
        done
        
        if [ -z "$BUILD_SCRIPT" ]; then
          echo "错误：未找到构建脚本！"
          exit 1
        fi
        
        chmod +x "$BUILD_SCRIPT"
        
        BUILD_ARGS=("$DISTRO" "$KERNEL_VER")
        if [[ "${{ github.event.inputs.use_china_mirror }}" == "true" ]]; then
          BUILD_ARGS+=("true")
        fi
        
        sudo "./$BUILD_SCRIPT" "${BUILD_ARGS[@]}"
        
        # 查找生成的镜像文件
        OUTPUT_PATTERN="raphael-${DISTRO}-kernel-${KERNEL_VER}.7z"
        OUTPUT_FILE=""
        
        for pattern in "$OUTPUT_PATTERN" "raphael-*-kernel-$KERNEL_VER.7z" "*.7z"; do
          if ls $pattern 2>/dev/null | grep -q .; then
            OUTPUT_FILE=$(ls $pattern | head -1)
            break
          fi
        done
        
        if [ -f "$OUTPUT_FILE" ]; then
          FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          NEW_FILENAME="${DISTRO}-kernel-${KERNEL_VER}-${BUILD_ID}-${TIMESTAMP}.7z"
          mv "$OUTPUT_FILE" "$NEW_FILENAME"
          
          echo "final_filename=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
        else
          echo "错误：未找到构建产物！"
          exit 1
        fi
    
    - name: "上传构建产物"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.distro }}-${{ needs.setup.outputs.kernel_version }}
        path: |
          ${{ matrix.distro }}-kernel-*.7z
          xiaomi-k20pro-boot.img
        if-no-files-found: error
        retention-days: 30
        compression-level: 0

  create-release:
    name: "发布 Release"
    needs: 
      - setup
      - build-rootfs
    runs-on: ubuntu-24.04-arm
    if: |
      github.event.inputs.skip_release != 'true' &&
      needs.build-rootfs.result == 'success'
    
    steps:
    - name: "下载构建产物"
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: '*'
        merge-multiple: true
    
    - name: "准备发布文件"
      id: prepare_release
      run: |
        RELEASE_DIR="./release"
        mkdir -p "$RELEASE_DIR"
        
        find ./artifacts -type f \( -name "*.7z" -o -name "*.img" \) -exec cp {} "$RELEASE_DIR/" \;
        
        cd "$RELEASE_DIR"
        sha256sum -- * > SHA256SUMS
        
        FILE_COUNT=$(ls -1 *.7z *.img 2>/dev/null | wc -l)
        TOTAL_SIZE=$(du -s . | cut -f1)
        TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024))
        
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "total_size_mb=$TOTAL_SIZE_MB" >> $GITHUB_OUTPUT
    
    - name: "生成版本标签"
      id: generate_tag
      run: |
        DATE_TAG=$(date -u '+%Y%m%d')
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        SHORT_SHA="${GITHUB_SHA:0:7}"
        
        RELEASE_TAG="debian-rootfs-$DATE_TAG-$KERNEL_VER-$SHORT_SHA"
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
    
    - name: "创建 GitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.release_tag }}
        name: "Debian for Raphael - ${{ steps.generate_tag.outputs.release_tag }}"
        body: |
          # Debian for Xiaomi Raphael (K20 Pro)
          
          ## 构建信息
          - **内核版本**: ${{ needs.setup.outputs.kernel_version }}
          - **构建SHA**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **构建时间**: ${{ github.event.created_at }}
          - **总大小**: ${{ steps.prepare_release.outputs.total_size_mb }} MB
          
          ${{ github.event.inputs.test_mode == 'true' && '> 测试模式：仅构建了Debian Server变体' || '' }}
          
          ## 默认凭据
          - **用户名**: `root`
          - **密码**: `1234`
          
          ## 文件列表
          使用以下命令验证文件完整性：
          ```bash
          sha256sum -c SHA256SUMS
          ```
        draft: false
        prerelease: false
        files: |
          release/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}