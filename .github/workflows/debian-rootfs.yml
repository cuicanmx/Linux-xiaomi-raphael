name: ğŸ§ Build Debian RootFS for Xiaomi Raphael

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (å¯¹åº”Releaseæ ‡ç­¾ï¼Œå¦‚6.18)'
        required: true
        default: '6.18'
      skip_release:
        description: 'è·³è¿‡åˆ›å»ºGitHub Release'
        required: false
        type: boolean
        default: false
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ (ä»…æ„å»ºdebian-server)'
        required: false
        type: boolean
        default: false
      use_china_mirror:
        description: 'ä½¿ç”¨ä¸­å›½æº (æ¨èå›½å†…ç”¨æˆ·å¼€å¯)'
        required: false
        type: boolean
        default: true

env:
  DEFAULT_KERNEL: '6.18'
  TERM: xterm

jobs:
  setup:
    name: "ğŸ”§ ç¯å¢ƒå‡†å¤‡"
    runs-on: ubuntu-24.04-arm
    outputs:
      kernel_version: ${{ steps.get_kernel_version.outputs.kernel_version }}
      distro_matrix: ${{ steps.generate_matrix.outputs.distro_matrix }}
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4
    
    - name: "ğŸ” ç¡®å®šå†…æ ¸ç‰ˆæœ¬"
      id: get_kernel_version
      run: |
        # ä¼˜å…ˆçº§ï¼šæ‰‹åŠ¨è¾“å…¥ > Releaseæ ‡ç­¾ > é»˜è®¤å€¼
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.kernel_version }}" ]]; then
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        elif [[ "${{ github.ref_type }}" == "tag" ]]; then
          KERNEL_VER="${GITHUB_REF#refs/tags/}"
          echo "ä½¿ç”¨Tagæ ‡ç­¾ä½œä¸ºå†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        else
          KERNEL_VER="${{ env.DEFAULT_KERNEL }}"
          echo "ä½¿ç”¨é»˜è®¤å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        fi
        
        # éªŒè¯å†…æ ¸ç‰ˆæœ¬æ ¼å¼
        if [[ ! "$KERNEL_VER" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
          echo "âŒ é”™è¯¯ï¼šå†…æ ¸ç‰ˆæœ¬æ ¼å¼æ— æ•ˆ: $KERNEL_VER"
          exit 1
        fi
        
        echo "kernel_version=$KERNEL_VER" >> $GITHUB_OUTPUT
        echo "âœ… å†…æ ¸ç‰ˆæœ¬ç¡®å®šä¸º: $KERNEL_VER"
    
    - name: "ğŸ“‹ ç”Ÿæˆå‘è¡Œç‰ˆçŸ©é˜µ"
      id: generate_matrix
      run: |
        # æ ¹æ®test_modeç”ŸæˆçŸ©é˜µ
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          DISTRO_MATRIX='["debian-server"]'
          echo "æµ‹è¯•æ¨¡å¼ï¼šä»…æ„å»º debian-server"
        else
          DISTRO_MATRIX='["debian-server", "debian-desktop"]'
          echo "æ­£å¸¸æ¨¡å¼ï¼šæ„å»ºæ‰€æœ‰å˜ä½“"
        fi
        
        echo "distro_matrix=$DISTRO_MATRIX" >> $GITHUB_OUTPUT

  build-rootfs:
    name: "ğŸ—ï¸ æ„å»º - ${{ matrix.distro }}"
    runs-on: ubuntu-24.04-arm
    needs: setup
    strategy:
      matrix:
        distro: ${{ fromJson(needs.setup.outputs.distro_matrix) }}
      fail-fast: false
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4
    
    - name: "ğŸ”§ å®‰è£…æ„å»ºå·¥å…·"
      run: |
        echo "ğŸ“¦ å®‰è£…å¿…éœ€çš„ç³»ç»Ÿå·¥å…·..."
        sudo apt-get update -q
        sudo apt-get install -y --no-install-recommends \
          debootstrap \
          p7zip-full \
          curl \
          gnupg \
          ca-certificates \
          lsb-release \
          bash
        
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
    
    - name: "ğŸ” éªŒè¯å†…æ ¸ç‰ˆæœ¬"
      run: |
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        echo "éªŒè¯å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        
        # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬æ–‡ä»¶æ¨¡å¼
        if ! [[ "$KERNEL_VER" =~ ^[0-9]+\.[0-9]+ ]]; then
          echo "âŒ é”™è¯¯ï¼šå†…æ ¸ç‰ˆæœ¬æ ¼å¼æ— æ•ˆ"
          exit 1
        fi
    
    - name: "ğŸ“¥ ä¸‹è½½å†…æ ¸åŒ…"
      id: download_kernel
      run: |
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        RELEASE_TAG="kernel-$KERNEL_VER"
        
        echo "ğŸ“¦ ä»Release [$RELEASE_TAG] ä¸‹è½½å†…æ ¸åŒ…..."
        
        # æ£€æŸ¥Releaseæ˜¯å¦å­˜åœ¨
        if ! gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°Release [$RELEASE_TAG]"
          echo "è¯·ç¡®ä¿å·²åˆ›å»ºå¯¹åº”çš„å†…æ ¸Release"
          exit 1
        fi
        
        # ä¸‹è½½å†…æ ¸åŒ…
        echo "æ­£åœ¨ä¸‹è½½å†…æ ¸åŒ…..."
        gh release download "$RELEASE_TAG" \
          --pattern "*-xiaomi-raphael*.deb" \
          --repo "${{ github.repository }}" \
          --clobber
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        echo "ğŸ“‹ ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la *.deb 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ°.debæ–‡ä»¶"
        
        DEB_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        if [ "$DEB_COUNT" -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæœªä¸‹è½½åˆ°ä»»ä½•å†…æ ¸åŒ…ï¼"
          exit 1
        fi
        
        echo "âœ… æˆåŠŸä¸‹è½½ $DEB_COUNT ä¸ªå†…æ ¸åŒ…:"
        for deb in *.deb; do
          echo "  - $deb ($(du -h "$deb" | cut -f1))"
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: "ğŸ—ï¸ æ‰§è¡ŒRootFSæ„å»º"
      id: build_rootfs
      timeout-minutes: 120  # æ­£ç¡®çš„è¶…æ—¶è®¾ç½®ä½ç½®
      run: |
        # è®¾ç½®ç»ˆç«¯ç¯å¢ƒå˜é‡
        export TERM=xterm
        export COLORTERM=truecolor
        
        DISTRO="${{ matrix.distro }}"
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        
        echo "========================================"
        echo "ğŸš€ å¼€å§‹æ„å»º RootFS"
        echo "----------------------------------------"
        echo "ğŸ“¦ å‘è¡Œç‰ˆ: $DISTRO"
        echo "ğŸ”§ å†…æ ¸: $KERNEL_VER"
        echo "ğŸ’» Runner: $(uname -m) ($(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2))"
        echo "ğŸ• å¼€å§‹æ—¶é—´: $(date)"
        echo "========================================"
        
        # æŸ¥æ‰¾æ„å»ºè„šæœ¬
        BUILD_SCRIPT=""
        for script in build-rootfs.sh debian-rootfs_build.sh build.sh; do
          if [ -f "$script" ]; then
            BUILD_SCRIPT="$script"
            break
          fi
        done
        
        if [ -z "$BUILD_SCRIPT" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºè„šæœ¬ï¼"
          echo "è¯·ç¡®ä¿å­˜åœ¨ä»¥ä¸‹ä»»ä¸€è„šæœ¬ï¼š"
          echo "  - build-rootfs.sh"
          echo "  - debian-rootfs_build.sh"
          echo "  - build.sh"
          exit 1
        fi
        
        echo "ğŸ“œ ä½¿ç”¨æ„å»ºè„šæœ¬: $BUILD_SCRIPT"
        chmod +x "$BUILD_SCRIPT"
        
        # å‡†å¤‡æ„å»ºå‚æ•°
        BUILD_ARGS=("$DISTRO" "$KERNEL_VER")
        if [[ "${{ github.event.inputs.use_china_mirror }}" == "true" ]]; then
          BUILD_ARGS+=("true")
          echo "ğŸ‡¨ğŸ‡³ å¯ç”¨ä¸­å›½é•œåƒæº"
        else
          echo "ğŸŒ ä½¿ç”¨é»˜è®¤é•œåƒæº"
        fi
        
        echo "â–¶ï¸ æ‰§è¡Œæ„å»ºå‘½ä»¤: sudo ./$BUILD_SCRIPT ${BUILD_ARGS[*]}"
        
        # æ‰§è¡Œæ„å»º
        if sudo "./$BUILD_SCRIPT" "${BUILD_ARGS[@]}"; then
          echo "âœ… RootFSæ„å»ºå®Œæˆ"
        else
          echo "âŒ RootFSæ„å»ºå¤±è´¥"
          exit 1
        fi
        
        # æŸ¥æ‰¾ç”Ÿæˆçš„é•œåƒæ–‡ä»¶
        echo "ğŸ” æŸ¥æ‰¾æ„å»ºäº§ç‰©..."
        OUTPUT_PATTERN="raphael-${DISTRO}-kernel-${KERNEL_VER}.7z"
        
        # å°è¯•å¤šç§å¯èƒ½çš„å‘½åæ¨¡å¼
        for pattern in \
          "$OUTPUT_PATTERN" \
          "raphael-*-kernel-$KERNEL_VER.7z" \
          "*.7z"; do
          
          if ls $pattern 2>/dev/null | grep -q .; then
            OUTPUT_FILE=$(ls $pattern | head -1)
            break
          fi
        done
        
        if [ -f "$OUTPUT_FILE" ]; then
          FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
          echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©:"
          echo "   ğŸ“¦ æ–‡ä»¶: $OUTPUT_FILE"
          echo "   ğŸ“ å¤§å°: $FILE_SIZE"
          
          # é‡å‘½åæ–‡ä»¶ï¼Œæ·»åŠ æ—¶é—´æˆ³å’Œå”¯ä¸€æ ‡è¯†
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          NEW_FILENAME="${DISTRO}-kernel-${KERNEL_VER}-${BUILD_ID}-${TIMESTAMP}.7z"
          mv "$OUTPUT_FILE" "$NEW_FILENAME"
          
          echo "final_filename=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          echo "original_pattern=$OUTPUT_PATTERN" >> $GITHUB_OUTPUT
        else
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºäº§ç‰©ï¼"
          echo "å½“å‰ç›®å½•æ–‡ä»¶:"
          ls -la
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†booté•œåƒ
        if [ -f "xiaomi-k20pro-boot.img" ]; then
          BOOT_SIZE=$(du -h "xiaomi-k20pro-boot.img" | cut -f1)
          echo "âœ… æ‰¾åˆ°booté•œåƒ: xiaomi-k20pro-boot.img ($BOOT_SIZE)"
          echo "has_boot_img=true" >> $GITHUB_OUTPUT
        fi
        
        echo "========================================"
        echo "ğŸ‰ RootFSæ„å»ºæˆåŠŸï¼"
        echo "----------------------------------------"
        echo "äº§ç‰©: $NEW_FILENAME"
        echo "å¤§å°: $FILE_SIZE"
        echo "æ—¶é—´: $(date)"
        echo "========================================"
    
    - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.distro }}-${{ needs.setup.outputs.kernel_version }}
        path: |
          ${{ matrix.distro }}-kernel-*.7z
          xiaomi-k20pro-boot.img
        if-no-files-found: error
        retention-days: 30
        compression-level: 0
    
    - name: "ğŸ“Š æ„å»ºç»Ÿè®¡"
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“Š æ„å»ºç»Ÿè®¡ - ${{ matrix.distro }}"
        echo "----------------------------------------"
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "å†…æ ¸ç‰ˆæœ¬: ${{ needs.setup.outputs.kernel_version }}"
        echo "äº§ç‰©: ${{ steps.build_rootfs.outputs.final_filename || 'æœªç”Ÿæˆ' }}"
        echo "å¤§å°: ${{ steps.build_rootfs.outputs.file_size || 'æœªçŸ¥' }}"
        echo "Runner: ${{ runner.os }}-${{ runner.arch }}"
        echo "æŒç»­æ—¶é—´: ${{ job.container.network }}"
        echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "========================================"

  create-release:
    name: "ğŸš€ å‘å¸ƒ Release"
    needs: 
      - setup
      - build-rootfs
    runs-on: ubuntu-24.04-arm
    if: |
      github.event.inputs.skip_release != 'true' &&
      needs.build-rootfs.result == 'success'
    
    steps:
    - name: "ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©"
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: '*'
        merge-multiple: true
    
    - name: "ğŸ“‹ å‡†å¤‡å‘å¸ƒæ–‡ä»¶"
      id: prepare_release
      run: |
        echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        RELEASE_DIR="./release"
        mkdir -p "$RELEASE_DIR"
        
        # ç§»åŠ¨æ‰€æœ‰äº§ç‰©åˆ°å‘å¸ƒç›®å½•
        find ./artifacts -type f \( -name "*.7z" -o -name "*.img" \) -exec cp {} "$RELEASE_DIR/" \;
        
        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨å’Œæ ¡éªŒå’Œ
        echo "ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ..."
        cd "$RELEASE_DIR"
        
        # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
        sha256sum -- * > SHA256SUMS
        echo "âœ… ç”ŸæˆSHA256æ ¡éªŒå’Œ"
        
        # ç”Ÿæˆè¯¦ç»†æ–‡ä»¶åˆ—è¡¨
        echo "ğŸ“‹ æ–‡ä»¶æ¸…å•ï¼š" > FILELIST.md
        echo "" >> FILELIST.md
        
        TOTAL_SIZE=0
        FILE_COUNT=0
        
        for file in *; do
          if [ -f "$file" ] && [ "$file" != "FILELIST.md" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            SIZE_BYTES=$(stat -c%s "$file")
            TOTAL_SIZE=$((TOTAL_SIZE + SIZE_BYTES))
            FILE_COUNT=$((FILE_COUNT + 1))
            
            # è·å–SHA256
            HASH=$(sha256sum "$file" | cut -d' ' -f1)
            
            echo "### $file" >> FILELIST.md
            echo "- **å¤§å°**: $SIZE" >> FILELIST.md
            echo "- **SHA256**: \`$HASH\`" >> FILELIST.md
            echo "" >> FILELIST.md
          fi
        done
        
        # è®¡ç®—æ€»å¤§å°
        TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
        
        echo "**ç»Ÿè®¡**:" >> FILELIST.md
        echo "- æ–‡ä»¶æ•°é‡: $FILE_COUNT" >> FILELIST.md
        echo "- æ€»å¤§å°: ${TOTAL_SIZE_MB} MB" >> FILELIST.md
        
        cd - > /dev/null
        
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "total_size_mb=$TOTAL_SIZE_MB" >> $GITHUB_OUTPUT
        
        # è¾“å‡ºæ–‡ä»¶åˆ—è¡¨å†…å®¹
        if [ -f "$RELEASE_DIR/FILELIST.md" ]; then
          cat "$RELEASE_DIR/FILELIST.md" | tee release_filelist.txt
          echo "filelist_text<<EOF" >> $GITHUB_OUTPUT
          cat release_filelist.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
        echo "âœ… å‡†å¤‡å®Œæˆ: $FILE_COUNT ä¸ªæ–‡ä»¶ï¼Œæ€»è®¡ ${TOTAL_SIZE_MB}MB"
    
    - name: "ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾"
      id: generate_tag
      run: |
        # åŸºäºæ—¥æœŸã€å†…æ ¸ç‰ˆæœ¬å’Œæäº¤ç”Ÿæˆæ ‡ç­¾
        DATE_TAG=$(date -u '+%Y%m%d')
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        SHORT_SHA="${GITHUB_SHA:0:7}"
        
        # åˆ›å»ºè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
        RELEASE_TAG="v${DATE_TAG}-kernel-${KERNEL_VER}-${SHORT_SHA}"
        
        echo "ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: $RELEASE_TAG"
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        
        # ä¹Ÿç”Ÿæˆä¸€ä¸ªå‹å¥½çš„æ˜¾ç¤ºåç§°
        DISPLAY_NAME="Debian for Raphael - $(date -u '+%Y-%m-%d')"
        echo "display_name=$DISPLAY_NAME" >> $GITHUB_OUTPUT
    
    - name: "ğŸš€ åˆ›å»º GitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.release_tag }}
        name: ${{ steps.generate_tag.outputs.display_name }}
        body: |
          # ğŸ§ Debian for Xiaomi Raphael (K20 Pro)
          
          ## ğŸ“‹ æ„å»ºä¿¡æ¯
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ needs.setup.outputs.kernel_version }}
          - **æ„å»ºæ—¶é—´**: ${{ github.event.created_at }}
          - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **å·¥ä½œæµ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **æ€»å¤§å°**: ${{ steps.prepare_release.outputs.total_size_mb }} MB
          
          ${{ github.event.inputs.test_mode == 'true' && '> âš ï¸ **æµ‹è¯•æ¨¡å¼**ï¼šä»…æ„å»ºäº†Debian Serverå˜ä½“' || '' }}
          
          ## âš ï¸ é‡è¦æç¤º
          ### é»˜è®¤å‡­æ®
          - **ç”¨æˆ·å**: `root`
          - **å¯†ç **: `1234`
          
          ### å®‰å…¨å»ºè®®
          1. é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
          2. å»ºè®®åˆ›å»ºæ™®é€šç”¨æˆ·å¹¶ç¦ç”¨rootè¿œç¨‹ç™»å½•
          3. æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å®‰å…¨æ›´æ–°
          
          ## ğŸ“¦ é•œåƒæ–‡ä»¶
          ${{ steps.prepare_release.outputs.filelist_text }}
          
          ## ğŸ” éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c SHA256SUMS
          ```
          
          ## â“ ä½¿ç”¨å¸®åŠ©
          æœ‰å…³åˆ·æœºå’Œä½¿ç”¨è¯´æ˜ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£ã€‚
          
          ---
          
          *æ„å»ºäº GitHub Actions â€¢ ${{ runner.os }}-${{ runner.arch }}*

        draft: false
        prerelease: false
        files: |
          release/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: "ğŸ“¢ å‘å¸ƒæˆåŠŸé€šçŸ¥"
      run: |
        echo "========================================"
        echo "ğŸ‰ Release åˆ›å»ºæˆåŠŸï¼"
        echo "----------------------------------------"
        echo "æ ‡ç­¾: ${{ steps.generate_tag.outputs.release_tag }}"
        echo "æ–‡ä»¶: ${{ steps.prepare_release.outputs.file_count }} ä¸ªæ–‡ä»¶"
        echo "å¤§å°: ${{ steps.prepare_release.outputs.total_size_mb }} MB"
        echo "Releaseé“¾æ¥:"
        echo "  https://github.com/${{ github.repository }}/releases/tag/${{ steps.generate_tag.outputs.release_tag }}"
        echo "========================================"