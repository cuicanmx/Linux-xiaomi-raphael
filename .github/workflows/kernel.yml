# This is a workflow for building kernel with caching
name: kernel

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  kernel:
    runs-on: ubuntu-24.04-arm
    strategy:
            matrix:
                version: [6.18]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y build-essential gcc-aarch64-linux-gnu bc flex bison 7zip kmod bash cpio binutils tar git wget dpkg libssl-dev ccache

      - name: Cache ccache directory
        uses: actions/cache@v3
        id: cache-ccache
        with:
          path: ~/.ccache
          key: kernel-ccache-${{ matrix.version }}-${{ runner.os }}
          restore-keys: |
            kernel-ccache-${{ matrix.version }}-${{ runner.os }}
            kernel-ccache-${{ matrix.version }}

      - name: Cache Linux source code
        uses: actions/cache@v3
        id: cache-linux
        with:
          path: linux
          key: linux-source-${{ matrix.version }}-${{ github.sha }}

      - name: Setup ccache environment
        run: |
          mkdir -p ~/.ccache
          echo "max_size = 10.0G" > ~/.ccache/ccache.conf
          echo "compression = true" >> ~/.ccache/ccache.conf
          echo "compression_level = 6" >> ~/.ccache/ccache.conf

      - name: Build kernel with ccache
        run: sh raphael-kernel_build.sh ${{ matrix.version }}
        env:
            CCACHE_DIR: ~/.ccache
            CCACHE_MAXSIZE: 10G
            PATH: /usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

      - name: Cache build artifacts
        uses: actions/cache@v3
        id: cache-artifacts
        with:
          path: |
            *.deb
            ~/.ccache
          key: kernel-artifacts-${{ matrix.version }}-${{ github.sha }}

      - name: Upload deb packages
        uses: actions/upload-artifact@v4.0.0
        with:
          # Artifact name
          name: xiaomi-raphael-debs_${{ matrix.version }}
          path: ${{ github.workspace }}/*.deb

      - name: Check if release exists
        id: check_release
        uses: actions/github-script@v6
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const releaseName = `Kernel ${process.env.VERSION}`;
            const existingRelease = releases.find(release => release.name === releaseName);
            
            core.setOutput('exists', !!existingRelease);
            core.setOutput('release_id', existingRelease?.id);
            core.setOutput('upload_url', existingRelease?.upload_url);
        env:
          VERSION: ${{ matrix.version }}

      - name: Create or update release
        id: create_release
        uses: actions/create-release@v1
        if: steps.check_release.outputs.exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: kernel-${{ matrix.version }}-${{ github.sha }}
          release_name: Kernel ${{ matrix.version }} (${{ github.sha }})
          draft: false
          prerelease: false

      - name: Upload Kernel DEB to Release
        uses: softprops/action-gh-release@v1
        with:
          files: linux-xiaomi-raphael.deb
          tag_name: kernel-${{ matrix.version }}-${{ github.sha }}
          name: linux-xiaomi-raphael-${{ matrix.version }}.deb
          body: |
            Kernel ${{ matrix.version }} for Xiaomi Raphael
            
            Built from commit: ${{ github.sha }}
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes necessary drivers and firmware
            - Compatible with Ubuntu/Debian rootfs

      - name: Upload Firmware DEB to Release
        uses: softprops/action-gh-release@v1
        with:
          files: firmware-xiaomi-raphael.deb
          tag_name: kernel-${{ matrix.version }}-${{ github.sha }}
          name: firmware-xiaomi-raphael-${{ matrix.version }}.deb
          body: |
            Firmware package for Xiaomi Raphael with Kernel ${{ matrix.version }}
            
            Includes device-specific firmware and drivers

      - name: Upload ALSA DEB to Release
        uses: softprops/action-gh-release@v1
        with:
          files: alsa-xiaomi-raphael.deb
          tag_name: kernel-${{ matrix.version }}-${{ github.sha }}
          name: alsa-xiaomi-raphael-${{ matrix.version }}.deb
          body: |
            ALSA configuration for Xiaomi Raphael with Kernel ${{ matrix.version }}
            
            Audio configuration and drivers for the device