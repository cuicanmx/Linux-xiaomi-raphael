name: ğŸ› ï¸ Build Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "å†…æ ¸ç‰ˆæœ¬å· (å¦‚: 6.18)"
        required: true
        default: "6.18"

jobs:
  build:
    name: "æ„å»ºå†…æ ¸ v${{ github.event.inputs.kernel_version || '6.18' }}"
    runs-on: ubuntu-24.04-arm

    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: "ğŸ’¾ è®¾ç½®ccacheç¼“å­˜ (å…ˆäºæ„å»ºå·¥å…·)"
        uses: actions/cache@v4
        id: cache-ccache
        with:
          path: /home/runner/.ccache
          # ä¼˜åŒ–: ä½¿ç”¨æ›´ç¨³å®šçš„ç¼“å­˜é”®ï¼ŒåŒ…å«å†…æ ¸ç‰ˆæœ¬å’Œåˆ†æ”¯å
          key: ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-${{ github.ref_name }}-${{ github.run_id }}
          # ä¼˜åŒ–: æ›´æ™ºèƒ½çš„ç¼“å­˜æ¢å¤ç­–ç•¥ï¼Œä¼˜å…ˆåŒ¹é…åŒå†…æ ¸ç‰ˆæœ¬å’Œåˆ†æ”¯
          restore-keys: |
            ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-${{ github.ref_name }}-
            ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-
            ${{ runner.os }}-ccache-kernel-

      - name: "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ"
        run: |
          echo "âš™ï¸ æ­£åœ¨å®‰è£…å¿…è¦çš„æ„å»ºå·¥å…·..."
          sudo apt update
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc ccache clang llvm lld
          echo "âœ… æ„å»ºå·¥å…·å®‰è£…å®Œæˆ"
          
          echo "ğŸ“¦ æ£€æŸ¥ccacheçŠ¶æ€..."
          ccache --version
          
          # ç¡®ä¿ccacheç›®å½•å­˜åœ¨ï¼ˆæ— è®ºç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼‰
          sudo mkdir -p /home/runner/.ccache
          sudo chown -R runner:runner /home/runner/.ccache
          sudo chmod -R 777 /home/runner/.ccache
          
          # ä¼˜åŒ–ccacheé…ç½®
          ccache --set-config=max_size=10G
          ccache --set-config=cache_dir=/home/runner/.ccache
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          # å…¼å®¹æ—§ç‰ˆæœ¬ccacheï¼Œä¸ä½¿ç”¨compressé€‰é¡¹
          # ccache --set-config=compress=1
          # ccache --set-config=compression_level=6
          
          echo "ğŸ“Š ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit }}"
          ccache --show-stats

      - name: "ğŸ”¨ ç¼–è¯‘å†…æ ¸"
        id: build
        run: |
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ç‰ˆæœ¬ ${{ github.event.inputs.kernel_version || '6.18' }}"
          echo "ğŸ’¾ ç¼“å­˜çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit }}"
          
          echo "ğŸ“Š ç¼–è¯‘å‰ccacheç»Ÿè®¡:"
          ccache --show-stats
          
          echo "âš™ï¸ æ‰§è¡Œç¼–è¯‘è„šæœ¬..."
          # è®¾ç½®ccacheç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ç¼–è¯‘è¿‡ç¨‹ä½¿ç”¨ccache
          export CCACHE_DIR=/home/runner/.ccache
          export CCACHE_MAXSIZE=10G
          export PATH="/usr/lib/ccache:$PATH"
          
          # æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦ä½¿ç”¨ccacheåŒ…è£…
          echo "æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦ä½¿ç”¨ccacheåŒ…è£…:"
          which clang
          clang --version
          echo "ccacheé…ç½®:"
          ccache --show-config | head -1
          
          # æ‰§è¡Œç¼–è¯‘
          # ä¼ é€’ç¯å¢ƒå˜é‡ç»™ç¼–è¯‘è„šæœ¬
          sudo -E bash raphael-kernel_build.sh "${{ github.event.inputs.kernel_version || '6.18' }}"
          
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
          echo "ğŸ“Š ç¼–è¯‘åccacheç»Ÿè®¡:"
          ccache --show-stats
          echo "ç¼“å­˜å‘½ä¸­ç‡è¯¦æƒ…:"
          # ä½¿ç”¨|| trueç¡®ä¿å³ä½¿æ²¡æœ‰åŒ¹é…ä¹Ÿä¸ä¼šå¯¼è‡´æ„å»ºå¤±è´¥
          ccache --show-stats --verbose | grep -E "(hit rate|cache hit|cache miss)" || true

      - name: "ğŸ’¾ ä¿å­˜ccacheç¼“å­˜"
        # æ— è®ºç¼–è¯‘æ˜¯å¦æˆåŠŸéƒ½ä¿å­˜ç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡æ„å»ºèƒ½åˆ©ç”¨å·²æœ‰ç¼“å­˜
        if: always()
        uses: actions/cache/save@v4
        with:
          path: /home/runner/.ccache
          key: ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-${{ github.ref_name }}-${{ github.run_id }}

      - name: "ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©"
        id: collect_artifacts
        run: |
          echo "ğŸ” æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©..."
          find . -name "*.deb" -type f | head -20
          
          echo "ğŸ“ ç¼–è¯‘äº§ç‰©åˆ—è¡¨:"
          ls -la *.deb 2>/dev/null || echo "âš ï¸  æœªæ‰¾åˆ° .deb æ–‡ä»¶"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h *.deb 2>/dev/null || echo "æš‚æ— äº§ç‰©æ–‡ä»¶"
          
          # ç»Ÿè®¡åŒ…æ•°é‡å¹¶è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          PKG_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
          echo "ğŸ“¦ å…±æ‰¾åˆ° $PKG_COUNT ä¸ªåŒ…æ–‡ä»¶"
          echo "pkg_count=$PKG_COUNT" >> $GITHUB_OUTPUT

      - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.event.inputs.kernel_version || '6.18' }}
          path: "*.deb"
          retention-days: 7
          if-no-files-found: error

      - name: "ğŸ·ï¸ åˆ›å»ºGitHub Release"
        if: steps.collect_artifacts.outputs.pkg_count > 0 && github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ github.event.inputs.kernel_version || '6.18' }}
          name: "Kernel ${{ github.event.inputs.kernel_version || '6.18' }}"
          body: |
            ## å†…æ ¸ç‰ˆæœ¬ ${{ github.event.inputs.kernel_version || '6.18' }}
            
            ğŸ“… æ„å»ºæ—¶é—´: ${{ github.event.created_at }}
            ğŸ”– å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version || '6.18' }}
            
            âš™ï¸ åŒ…å«ä»¥ä¸‹åŒ…:
            - linux-xiaomi-raphael_*.deb
            - firmware-xiaomi-raphael_*.deb  
            - alsa-xiaomi-raphael_*.deb
            
            ğŸ› è‡ªåŠ¨æ„å»ºäº GitHub Actions
          draft: false
          prerelease: false
          files: "*.deb"
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ“‹ æ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "ğŸ“Š ======== æ„å»ºæ€»ç»“ ========"
          echo "ğŸ—ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ¯ ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version || '6.18' }}"
          echo "ğŸ’¾ ç¼“å­˜å‘½ä¸­: ${{ steps.cache-ccache.outputs.cache-hit }}"
          echo "ğŸ“ äº§ç‰©æ•°é‡: ${{ steps.collect_artifacts.outputs.pkg_count || 0 }}"
          echo "â±ï¸  è¿è¡ŒçŠ¶æ€: ${{ job.status }}"
          echo "==========================="