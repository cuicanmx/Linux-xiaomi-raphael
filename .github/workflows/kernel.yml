name: Build Kernel 

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "å†…æ ¸ç‰ˆæœ¬å·"
        required: true
        default: "6.18"

jobs:
  build:
    name: "æ„å»ºå†…æ ¸ v${{ inputs.kernel_version || '6.18' }}"
    runs-on: ubuntu-24.04-arm
    
    strategy:
      matrix:
        # ä»æ‰‹åŠ¨è§¦å‘è¾“å…¥è·å–ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¿æŒä¸€ä¸ªé»˜è®¤å€¼
        version: ['${{ inputs.kernel_version || '6.18' }}']

    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ"
      run: |
        echo "âš™ï¸ æ­£åœ¨å®‰è£…å¿…è¦çš„æ„å»ºå·¥å…·..."
        sudo apt update
        sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc ccache
        echo "âœ… æ„å»ºå·¥å…·å®‰è£…å®Œæˆ"
        
        echo "ğŸ“¦ æ£€æŸ¥ccacheçŠ¶æ€..."
        ccache --version
        ccache --max-size=10G
        ccache --show-stats

    - name: "ğŸ’¾ è®¾ç½®ccacheç¼“å­˜"
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: "ğŸ”¨ ç¼–è¯‘å†…æ ¸"
      run: |
        echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ç‰ˆæœ¬ ${{ matrix.version }}"
        echo "ğŸ’¾ ä½¿ç”¨ ccache åŠ é€Ÿç¼–è¯‘"
        echo "ğŸ“Š ccache ç»Ÿè®¡ä¿¡æ¯:"
        ccache --show-stats
        
        echo "âš™ï¸ æ‰§è¡Œç¼–è¯‘è„šæœ¬..."
        sh raphael-kernel_build.sh ${{ matrix.version }}
        
        echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
        echo "ğŸ“Š ç¼–è¯‘åccacheç»Ÿè®¡:"
        ccache --show-stats
      env:
        CCACHE_DIR: ~/.ccache
        CCACHE_MAXSIZE: 10G
        PATH: /usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

    - name: "ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©"
      run: |
        echo "ğŸ” æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©..."
        find . -name "*.deb" -type f | head -20
        
        echo "ğŸ“ ç¼–è¯‘äº§ç‰©åˆ—è¡¨:"
        ls -la *.deb || echo "âš ï¸  æœªæ‰¾åˆ° .deb æ–‡ä»¶"
        echo ""
        echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
        du -h *.deb 2>/dev/null || echo "æš‚æ— äº§ç‰©æ–‡ä»¶"
        
        # Count packages
        PKG_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        echo "ğŸ“¦ å…±æ‰¾åˆ° $PKG_COUNT ä¸ªåŒ…æ–‡ä»¶"

    - name: "ğŸ“¤ ä¸Šä¼ äº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ matrix.version }}
        path: "*.deb"
        retention-days: 7

    - name: "ğŸ·ï¸ åˆ›å»ºRelease"
      if: github.event_name == 'workflow_dispatch'
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kernel-${{ matrix.version }}
        name: "Kernel ${{ matrix.version }}"
        body: |
          ## å†…æ ¸ç‰ˆæœ¬ ${{ matrix.version }}
          
          ğŸ“… æ„å»ºæ—¶é—´: ${{ fromJSON(github.event).inputs.kernel_version || matrix.version }}
          
          âš™ï¸ åŒ…å«ä»¥ä¸‹åŒ…:
          - linux-xiaomi-raphael_${{ matrix.version }}*.deb
          - firmware-xiaomi-raphael_${{ matrix.version }}*.deb
          - alsa-xiaomi-raphael_${{ matrix.version }}*.deb
          
          ğŸ› è‡ªåŠ¨æ„å»ºäº GitHub Actions
        draft: false
        prerelease: false
        files: "*.deb"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ“‹ æ„å»ºæ€»ç»“"
      if: always()
      run: |
        echo "ğŸ“Š ======== æ„å»ºæ€»ç»“ ========"
        echo "ğŸ—ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
        echo "ğŸ¯ ç›®æ ‡ç‰ˆæœ¬: ${{ matrix.version }}"
        echo "ğŸ“ äº§ç‰©æ•°é‡: $PKG_COUNT"
        echo "â±ï¸  è¿è¡Œæ—¶é—´: ${{ job.status }}"
        echo "==========================="