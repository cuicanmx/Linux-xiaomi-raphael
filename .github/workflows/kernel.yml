name: ğŸ› ï¸ Build Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "å†…æ ¸ç‰ˆæœ¬å· (å¦‚: 6.18)"
        required: true
        default: "6.18"

jobs:
  build:
    name: "æ„å»ºå†…æ ¸ v${{ github.event.inputs.kernel_version || '6.18' }}"
    runs-on: ubuntu-24.04-arm

    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ"
        run: |
          echo "âš™ï¸ æ­£åœ¨å®‰è£…å¿…è¦çš„æ„å»ºå·¥å…·..."
          sudo apt update
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc ccache
          echo "âœ… æ„å»ºå·¥å…·å®‰è£…å®Œæˆ"
          
          echo "ğŸ“¦ æ£€æŸ¥ccacheçŠ¶æ€..."
          ccache --version
          ccache --max-size=10G
          ccache --show-stats

      - name: "ğŸ’¾ è®¾ç½®ccacheç¼“å­˜"
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          # å…³é”®ä¿®å¤ï¼šç¼“å­˜é”®ä½¿ç”¨åŠ¨æ€å†…æ ¸ç‰ˆæœ¬ï¼Œç¡®ä¿ä¸åŒç‰ˆæœ¬ç¼“å­˜éš”ç¦»
          key: ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-
            ${{ runner.os }}-ccache-kernel-

      - name: "ğŸ”¨ ç¼–è¯‘å†…æ ¸"
        run: |
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ç‰ˆæœ¬ ${{ github.event.inputs.kernel_version || '6.18' }}"
          echo "ğŸ’¾ ä½¿ç”¨ ccache åŠ é€Ÿç¼–è¯‘"
          echo "ğŸ“Š ccache ç»Ÿè®¡ä¿¡æ¯:"
          ccache --show-stats
          
          echo "âš™ï¸ æ‰§è¡Œç¼–è¯‘è„šæœ¬..."
          # ä¼ é€’åŠ¨æ€ç‰ˆæœ¬å·ç»™ç¼–è¯‘è„šæœ¬
          sudo bash raphael-kernel_build.sh "${{ github.event.inputs.kernel_version || '6.18' }}"
          
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
          echo "ğŸ“Š ç¼–è¯‘åccacheç»Ÿè®¡:"
          ccache --show-stats
        env:
          CCACHE_DIR: ~/.ccache
          CCACHE_MAXSIZE: 10G
          PATH: /usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

      - name: "ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©"
        id: collect_artifacts
        run: |
          echo "ğŸ” æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©..."
          find . -name "*.deb" -type f | head -20
          
          echo "ğŸ“ ç¼–è¯‘äº§ç‰©åˆ—è¡¨:"
          ls -la *.deb 2>/dev/null || echo "âš ï¸  æœªæ‰¾åˆ° .deb æ–‡ä»¶"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h *.deb 2>/dev/null || echo "æš‚æ— äº§ç‰©æ–‡ä»¶"
          
          # ç»Ÿè®¡åŒ…æ•°é‡å¹¶è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          PKG_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
          echo "ğŸ“¦ å…±æ‰¾åˆ° $PKG_COUNT ä¸ªåŒ…æ–‡ä»¶"
          echo "pkg_count=$PKG_COUNT" >> $GITHUB_OUTPUT

      - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          # å…³é”®ä¿®å¤ï¼šäº§ç‰©åç§°åŒ…å«åŠ¨æ€å†…æ ¸ç‰ˆæœ¬ï¼Œä¾¿äºåŒºåˆ†
          name: kernel-${{ github.event.inputs.kernel_version || '6.18' }}
          path: "*.deb"
          retention-days: 7
          if-no-files-found: error

      - name: "ğŸ·ï¸ åˆ›å»ºGitHub Release"
        # å…³é”®ä¿®å¤ï¼šä»…åœ¨æˆåŠŸç”ŸæˆåŒ…æ–‡ä»¶åæ‰åˆ›å»ºRelease
        if: steps.collect_artifacts.outputs.pkg_count > 0 && github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          # å…³é”®ä¿®å¤ï¼šReleaseæ ‡ç­¾ä½¿ç”¨åŠ¨æ€å†…æ ¸ç‰ˆæœ¬
          tag_name: kernel-${{ github.event.inputs.kernel_version || '6.18' }}
          name: "Kernel ${{ github.event.inputs.kernel_version || '6.18' }}"
          body: |
            ## å†…æ ¸ç‰ˆæœ¬ ${{ github.event.inputs.kernel_version || '6.18' }}
            
            ğŸ“… æ„å»ºæ—¶é—´: ${{ github.event.inputs.kernel_version || '6.18' }}
            
            âš™ï¸ åŒ…å«ä»¥ä¸‹åŒ…:
            - linux-xiaomi-raphael_*.deb
            - firmware-xiaomi-raphael_*.deb  
            - alsa-xiaomi-raphael_*.deb
            
            ğŸ› è‡ªåŠ¨æ„å»ºäº GitHub Actions
          draft: false
          prerelease: false
          files: "*.deb"
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ“‹ æ„å»ºæ€»ç»“"
        if: always()
        run: |
          echo "ğŸ“Š ======== æ„å»ºæ€»ç»“ ========"
          echo "ğŸ—ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ¯ ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version || '6.18' }}"
          echo "ğŸ“ äº§ç‰©æ•°é‡: ${{ steps.collect_artifacts.outputs.pkg_count || 0 }}"
          echo "â±ï¸  è¿è¡ŒçŠ¶æ€: ${{ job.status }}"
          echo "==========================="