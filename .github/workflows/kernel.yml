name: ğŸ› ï¸ Build Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "å†…æ ¸ç‰ˆæœ¬å· (å¦‚: 6.18)"
        required: true
        default: "6.18"

jobs:
  build:
    name: "æ„å»ºå†…æ ¸ v${{ github.event.inputs.kernel_version || '6.18' }}"
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write

    steps:
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: "ğŸ’¾ è®¾ç½®ccacheç¼“å­˜"
        uses: actions/cache@v4
        id: cache-ccache
        with:
          path: /home/runner/.ccache
          key: ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-${{ github.ref_name }}
          restore-keys: |
            ${{ runner.os }}-ccache-kernel-${{ github.event.inputs.kernel_version || '6.18' }}-
            ${{ runner.os }}-ccache-kernel-
          # è®¾ç½®ç¼“å­˜å¤§å°é™åˆ¶ï¼Œé¿å…ç¼“å­˜è¿‡å¤§
          cache-size: 10GB

      - name: "ğŸ”§ è®¾ç½®æ„å»ºç¯å¢ƒ"
        run: |
          echo "âš™ï¸ æ­£åœ¨å®‰è£…å¿…è¦çš„æ„å»ºå·¥å…·..."
          sudo apt update
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc ccache clang llvm lld
          echo "âœ… æ„å»ºå·¥å…·å®‰è£…å®Œæˆ"
          
          # ç¡®ä¿ccacheç›®å½•å­˜åœ¨ï¼ˆæ— è®ºç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼‰
          mkdir -p /home/runner/.ccache
          
          # ä¼˜åŒ–ccacheé…ç½®
          ccache --set-config=max_size=10G
          ccache --set-config=cache_dir=/home/runner/.ccache
          ccache --set-config=sloppiness=file_macro,locale,time_macros
          
          echo "ğŸ“Š ç¼“å­˜æ¢å¤çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit }}"

      - name: "ğŸ”¨ ç¼–è¯‘å†…æ ¸"
        id: build
        run: |
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ç‰ˆæœ¬ ${{ github.event.inputs.kernel_version || '6.18' }}"
          echo "ğŸ’¾ ç¼“å­˜çŠ¶æ€: ${{ steps.cache-ccache.outputs.cache-hit }}"
          
          # è®¾ç½®ccacheç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ç¼–è¯‘è¿‡ç¨‹ä½¿ç”¨ccache
          export CCACHE_DIR=/home/runner/.ccache
          export CCACHE_MAXSIZE=10G
          export PATH="/usr/lib/ccache:$PATH"
          
          # æ‰§è¡Œç¼–è¯‘
          # ä¼ é€’ç¯å¢ƒå˜é‡ç»™ç¼–è¯‘è„šæœ¬
          bash raphael-kernel_build.sh "${{ github.event.inputs.kernel_version || '6.18' }}"
          
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
          echo "ğŸ“Š ç¼–è¯‘åccacheç»Ÿè®¡:"
          ccache --show-stats --verbose | grep -E "(hit rate|cache hit|cache miss|max size)" || true

      - name: "ğŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©"
        id: collect_artifacts
        run: |
          echo "ğŸ” æŸ¥æ‰¾ç¼–è¯‘äº§ç‰©..."
          find . -name "*.deb" -type f | head -20
          
          echo "ğŸ“ ç¼–è¯‘äº§ç‰©åˆ—è¡¨:"
          ls -la *.deb 2>/dev/null || echo "âš ï¸  æœªæ‰¾åˆ° .deb æ–‡ä»¶"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h *.deb 2>/dev/null || echo "æš‚æ— äº§ç‰©æ–‡ä»¶"
          
          # ç»Ÿè®¡åŒ…æ•°é‡å¹¶è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          PKG_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
          echo "ğŸ“¦ å…±æ‰¾åˆ° $PKG_COUNT ä¸ªåŒ…æ–‡ä»¶"
          echo "pkg_count=$PKG_COUNT" >> $GITHUB_OUTPUT

      - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.event.inputs.kernel_version || '6.18' }}
          path: "*.deb"
          retention-days: 7
          if-no-files-found: error

      - name: "ğŸ·ï¸ åˆ›å»ºGitHub Release"
        if: steps.collect_artifacts.outputs.pkg_count > 0 && github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ github.event.inputs.kernel_version || '6.18' }}
          name: "Kernel ${{ github.event.inputs.kernel_version || '6.18' }}"
          body: |
            ğŸ§© Kernel ${{ github.event.inputs.kernel_version || '6.18' }}
            
            --- 
            
            ### ğŸ”§ æ„å»ºä¿¡æ¯
            | é¡¹ç›® | è¯¦æƒ… |
            |------|------|
            | å†…æ ¸ç‰ˆæœ¬ | ${{ github.event.inputs.kernel_version || '6.18' }} |
            | æ„å»ºæ–¹å¼ | GitHub Actions è‡ªåŠ¨æ„å»º |
            
            --- 
            
            ### ğŸ“¦ åŒ…å«åŒ…
            - linux-xiaomi-raphael.deb
            - firmware-xiaomi-raphael.deb  
            - alsa-xiaomi-raphael.deb
            - install.7z
          draft: false
          prerelease: false
          files: "*.deb"
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}