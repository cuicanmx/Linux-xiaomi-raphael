# This is a workflow for building kernel with caching
name: kernel

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  kernel:
    runs-on: ubuntu-24.04-arm
    strategy:
            matrix:
                version: [6.18]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y build-essential gcc-aarch64-linux-gnu bc flex bison 7zip kmod bash cpio binutils tar git wget dpkg libssl-dev ccache

      - name: Cache ccache directory
        uses: actions/cache@v3
        id: cache-ccache
        with:
          path: ~/.ccache
          key: kernel-ccache-${{ matrix.version }}-${{ runner.os }}
          restore-keys: |
            kernel-ccache-${{ matrix.version }}-${{ runner.os }}
            kernel-ccache-${{ matrix.version }}

      - name: Setup ccache environment
        run: |
          mkdir -p ~/.ccache
          echo "max_size = 10.0G" > ~/.ccache/ccache.conf
          echo "compression = true" >> ~/.ccache/ccache.conf
          echo "compression_level = 6" >> ~/.ccache/ccache.conf

      - name: Build kernel with ccache
        run: sh raphael-kernel_build.sh ${{ matrix.version }}
        env:
            CCACHE_DIR: ~/.ccache
            CCACHE_MAXSIZE: 10G
            PATH: /usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin



      - name: Upload deb packages
        uses: actions/upload-artifact@v4.0.0
        with:
          # Artifact name
          name: xiaomi-raphael-debs_${{ matrix.version }}
          path: ${{ github.workspace }}/*.deb

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: always()
        with:
          tag_name: kernel-${{ matrix.version }}
          name: Kernel ${{ matrix.version }}
          body: |
            Kernel ${{ matrix.version }} for Xiaomi Raphael
            
            Built from commit: ${{ github.sha }}
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes necessary drivers and firmware
            - Compatible with Ubuntu/Debian rootfs
          draft: false
          prerelease: false

      - name: Upload DEB Packages to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-xiaomi-raphael.deb
            firmware-xiaomi-raphael.deb
            alsa-xiaomi-raphael.deb
          tag_name: kernel-${{ matrix.version }}
          name: Kernel ${{ matrix.version }}
          body: |
            Kernel ${{ matrix.version }} for Xiaomi Raphael
            
            Built from commit: ${{ github.sha }}
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes necessary drivers and firmware
            - Compatible with Ubuntu/Debian rootfs
          draft: false
          prerelease: false