# This is a workflow for building kernel with caching
name: kernel

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  kernel:
    runs-on: ubuntu-24.04-arm
    strategy:
            matrix:
                version: [6.18]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…å†…æ ¸ç¼–è¯‘ä¾èµ–åŒ…"
          sudo apt update
          sudo apt install -y build-essential gcc-aarch64-linux-gnu bc flex bison 7zip kmod bash cpio binutils tar git wget dpkg libssl-dev ccache
          echo "âœ… ä¾èµ–åŒ…å®‰è£…å®Œæˆ"

      - name: Cache ccache directory
        uses: actions/cache@v3
        id: cache-ccache
        with:
          path: ~/.ccache
          key: kernel-ccache-${{ matrix.version }}-${{ runner.os }}
          restore-keys: |
            kernel-ccache-${{ matrix.version }}-${{ runner.os }}
            kernel-ccache-${{ matrix.version }}

      - name: Setup ccache environment
        run: |
          echo "âš™ï¸  è®¾ç½® ccache ç¼–è¯‘ç¼“å­˜"
          mkdir -p ~/.ccache
          echo "max_size = 10.0G" > ~/.ccache/ccache.conf
          echo "compression = true" >> ~/.ccache/ccache.conf
          echo "compression_level = 6" >> ~/.ccache/ccache.conf
          echo "ğŸ“Š ccache é…ç½®å®Œæˆï¼Œç¼“å­˜å¤§å°: 10GB"

      - name: Build kernel with ccache
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å†…æ ¸ç‰ˆæœ¬ ${{ matrix.version }}"
          echo "ğŸ’¾ ä½¿ç”¨ ccache åŠ é€Ÿç¼–è¯‘"
          sh raphael-kernel_build.sh ${{ matrix.version }}
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
        env:
            CCACHE_DIR: ~/.ccache
            CCACHE_MAXSIZE: 10G
            PATH: /usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

      - name: List build artifacts
        run: |
          echo "ğŸ“ ç¼–è¯‘äº§ç‰©åˆ—è¡¨:"
          ls -la *.deb || echo "âš ï¸  æœªæ‰¾åˆ° .deb æ–‡ä»¶"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h *.deb 2>/dev/null || echo "æš‚æ— äº§ç‰©æ–‡ä»¶"

      - name: Create Release
        run: |
          echo "ğŸš€ å‡†å¤‡åˆ›å»ºå†…æ ¸ Release"
          echo "ğŸ·ï¸  Release æ ‡ç­¾: kernel-${{ matrix.version }}"
          echo "ğŸ“¦ è¦ä¸Šä¼ çš„å†…æ ¸åŒ…:"
          ls -la *.deb 2>/dev/null || echo "æ— å†…æ ¸åŒ…æ–‡ä»¶"
          echo ""
          echo "ğŸ‘¨â€ğŸ’» å¼€å§‹åˆ›å»ºå†…æ ¸ Release..."
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: always()
        with:
          tag_name: kernel-${{ matrix.version }}
          name: Kernel ${{ matrix.version }}
          body: |
            Kernel ${{ matrix.version }} for Xiaomi Raphael
            
            Built from commit: ${{ github.sha }}
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes necessary drivers and firmware
            - Compatible with Ubuntu/Debian rootfs
          files: "*.deb"
          draft: false
          prerelease: false

      - name: Upload DEB Packages to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-xiaomi-raphael.deb
            firmware-xiaomi-raphael.deb
            alsa-xiaomi-raphael.deb
          tag_name: kernel-${{ matrix.version }}
          name: Kernel ${{ matrix.version }}
          body: |
            Kernel ${{ matrix.version }} for Xiaomi Raphael
            
            Built from commit: ${{ github.sha }}
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes necessary drivers and firmware
            - Compatible with Ubuntu/Debian rootfs
          draft: false
          prerelease: false