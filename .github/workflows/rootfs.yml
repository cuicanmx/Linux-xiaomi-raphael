# This is a workflow for building rootfs
name: rootfs

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  rootfs:
    # The type of runner that the job will run on
    runs-on: ubuntu-24.04-arm
    strategy:
            matrix:
                distro: [debian-server, debian-desktop, ubuntu-server, ubuntu-desktop]
                kernel: [6.18]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Download kernel deb packages from release with tag kernel-6.18
      - name: Download Kernel DEB Packages from Release
        run: |
          mkdir -p xiaomi-raphael-debs_${{ matrix.kernel }}
          gh release download kernel-${{ matrix.kernel }} \
            --pattern "*.deb" \
            --dir xiaomi-raphael-debs_${{ matrix.kernel }} \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y debootstrap 7zip kmod tar wget

      - name: Build rootfs
        run: sudo sh raphael-rootfs_build.sh ${{ matrix.distro }} ${{ matrix.kernel }}

      - name: Rename rootfs file
        run: mv rootfs.7z raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z

      - name: Upload rootfs artifact
        uses: actions/upload-artifact@v4
        with:
          name: raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z
          path: raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z
          retention-days: 1

  create-release:
    needs: rootfs
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Download all rootfs artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: ls -la artifacts/

      - name: Create and Upload RootFS Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: rootfs
          name: RootFS Build ${{ github.sha }}
          body: |
            RootFS for Xiaomi Raphael with multiple distributions and Kernel ${{ matrix.kernel }}
            
            Built from commit: ${{ github.sha }}
            
            Available distributions:
            - debian-server
            - debian-desktop (Xfce)
            - ubuntu-server
            - ubuntu-desktop
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes kernel ${{ matrix.kernel }} and necessary drivers
            - Root password: 1234
          files: artifacts/*.7z
          draft: false
          prerelease: false