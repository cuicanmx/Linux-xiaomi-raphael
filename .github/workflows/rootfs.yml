# This is a workflow for building rootfs
name: rootfs

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  rootfs:
    # The type of runner that the job will run on
    runs-on: ubuntu-24.04-arm
    strategy:
            matrix:
                desktop: [ubuntu-desktop]
                kernel: [6.18]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Download kernel deb packages from release with tag kernel-6.18
      - name: Download Kernel DEB Packages from Release
        run: |
          gh release download kernel-${{ matrix.kernel }} \
            --pattern "*.deb" \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y debootstrap 7zip kmod tar wget

      - name: Build rootfs
        run: sudo sh raphael-rootfs_build.sh ${{ matrix.desktop }} ${{ matrix.kernel }}

      - name: Create and Upload RootFS Release
        uses: softprops/action-gh-release@v1
        if: always()
        with:
          tag_name: rootfs-${{ matrix.desktop }}-${{ matrix.kernel }}
          name: RootFS ${{ matrix.desktop }} ${{ matrix.kernel }}
          body: |
            RootFS for Xiaomi Raphael with ${{ matrix.desktop }} desktop and Kernel ${{ matrix.kernel }}
            
            Built from commit: ${{ github.sha }}
            
            Features:
            - Ubuntu ${{ matrix.desktop }} desktop environment
            - Optimized for Xiaomi Raphael device
            - Includes kernel ${{ matrix.kernel }} and necessary drivers
          files: rootfs.7z
          draft: false
          prerelease: false