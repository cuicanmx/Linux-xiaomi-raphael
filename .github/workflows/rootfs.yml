name: ğŸ§Build RootFS

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (å¯¹åº”Releaseæ ‡ç­¾ï¼Œå¦‚ 6.18)'
        required: true
        default: '6.18'
      build_type:
        description: 'æ„å»ºç±»å‹é€‰æ‹©'
        options:
          - all
          - server-only
          - desktop-only
        required: true
        type: choice
        default: 'all'
      skip_release:
        description: 'è·³è¿‡åˆ›å»ºGitHub Release'
        required: false
        type: boolean
        default: false

jobs:
  prepare-release:
    name: "ğŸ“ å‡†å¤‡Release"
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.generate_tag.outputs.release_tag }}
      kernel_version: ${{ steps.kernel_version.outputs.kernel_version }}
    if: ${{ !github.event.inputs.skip_release }}
    steps:
    - name: "ğŸ“¦ è·å–å†…æ ¸ç‰ˆæœ¬"
      id: kernel_version
      run: |
        KERNEL_VER='${{ github.event.inputs.kernel_version || "6.18" }}'
        echo "kernel_version=$KERNEL_VER" >> $GITHUB_OUTPUT

    - name: "ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾"
      id: generate_tag
      run: |
        DATE_TAG=$(date -u '+%Y%m%d')
        KERNEL_REF="${{ steps.kernel_version.outputs.kernel_version }}"
        SHORT_SHA="${GITHUB_SHA:0:8}"
        RELEASE_TAG="rootfs-$DATE_TAG-$KERNEL_REF-$SHORT_SHA"
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

    - name: "ğŸ“„ æå‰åˆ›å»ºGitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.release_tag }}
        name: "Ubuntu/Debian for Raphael - ${{ steps.generate_tag.outputs.release_tag }}"
        body: |
          ğŸ§ Ubuntu/Debian for Raphael
          
          --- 
          
          ### ğŸ“‹ æ„å»ºä¿¡æ¯
          | é¡¹ç›® | è¯¦æƒ… |
          |------|------|
          | å†…æ ¸ç‰ˆæœ¬ | ${{ steps.kernel_version.outputs.kernel_version }} |
          | æ„å»ºSHA | [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
          | æ„å»ºç±»å‹ | ${{ github.event.inputs.build_type || 'all' }} |
          | åŒ…å«å˜ä½“ | ${{ 
              github.event.inputs.build_type == 'server-only' && 'Debian Server, Ubuntu Server' ||
              github.event.inputs.build_type == 'desktop-only' && 'Debian Desktop, Ubuntu Desktop' ||
              'Debian Server/Desktop, Ubuntu Server/Desktop'
            }} |
          | æ€»å¤§å° | æ„å»ºä¸­... |
          
          --- 
          
          ### ğŸ” é»˜è®¤å‡­æ®
          
          **æœåŠ¡å™¨ç‰ˆ**
          - ç”¨æˆ·å: `root`
          - å¯†ç : `1234` (é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹ï¼)
          
          **æ¡Œé¢ç‰ˆ**
          - ç”¨æˆ·å: `luser`
          - å¯†ç : `luser`
          - è‡ªåŠ¨ç™»å½•: å·²å¯ç”¨
          - æ¡Œé¢ç¯å¢ƒ: GNOME + LightDM
          
          --- 
          
          ### ğŸ›¡ï¸ å®‰å…¨å»ºè®®
          1. é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
          2. ç¦ç”¨rootè¿œç¨‹ç™»å½•ï¼ˆå¯é€‰ï¼‰
          3. é…ç½®é˜²ç«å¢™è§„åˆ™

          --- 
          
          ### ğŸ“¦ é•œåƒæ–‡ä»¶
          æ„å»ºä¸­...
        draft: false
        prerelease: false
        files: []
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-rootfs:
    name: "ğŸ—ï¸ æ„å»º - ${{ matrix.distro }}"
    runs-on: ubuntu-24.04-arm
    needs: prepare-release
    env:
      APT_CACHE_DIR: /opt/apt-cache
      RELEASE_TAG: ${{ needs.prepare-release.outputs.release_tag }}
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        distro: ${{ 
            github.event.inputs.build_type == 'server-only'
            && fromJSON('["debian-server", "ubuntu-server"]')
            || github.event.inputs.build_type == 'desktop-only'
            && fromJSON('["debian-desktop", "ubuntu-desktop"]')
            || fromJSON('["debian-server", "debian-desktop", "ubuntu-server", "ubuntu-desktop"]')
            }}
      fail-fast: false

    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4

    - name: "ğŸ”§ å®‰è£…æ„å»ºå·¥å…·"
      run: |
        echo "å®‰è£…å¿…éœ€çš„ç³»ç»Ÿå·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap \
          p7zip-full \
          curl
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
        docker rmi -f $(docker images -q) 2>/dev/null || true
        [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
        sudo swapoff -a
        sudo rm -f /swapfile /mnt/swapfile

    - name: "ğŸ“¥ ä¸‹è½½å†…æ ¸åŒ…"
      id: download_kernel
      run: |
        KERNEL_VER="${{ needs.prepare-release.outputs.kernel_version }}"
        echo "ä» Release [kernel-$KERNEL_VER] ä¸‹è½½å†…æ ¸åŒ…..."
        
        # ä½¿ç”¨GitHub CLIä¸‹è½½Releaseæ–‡ä»¶
        gh release download "kernel-$KERNEL_VER" \
          --pattern "*-xiaomi-raphael*.deb" \
          --repo "${{ github.repository }}" \
          --clobber
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        DEB_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        if [ $DEB_COUNT -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæœªä¸‹è½½åˆ°ä»»ä½•å†…æ ¸åŒ…ï¼"
          exit 1
        fi
        
        echo "âœ… æˆåŠŸä¸‹è½½ $DEB_COUNT ä¸ªå†…æ ¸åŒ…"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ—ï¸ æ‰§è¡ŒRootFSæ„å»º"
      id: build_rootfs
      run: |
        DISTRO="${{ matrix.distro }}"
        KERNEL_VER="${{ needs.prepare-release.outputs.kernel_version }}"
        
        echo "========================================"
        echo "å¼€å§‹æ„å»º RootFS"
        echo "----------------------------------------"
        echo "å‘è¡Œç‰ˆ: $DISTRO"
        echo "å†…æ ¸: $KERNEL_VER"
        echo "Runner: $(uname -m)"
        echo "æ—¶é—´: $(date)"
        echo "========================================"
        
        # èµ‹äºˆæ‰§è¡Œæƒé™å¹¶æ‰§è¡Œæ„å»ºè„šæœ¬
        chmod +x raphael-rootfs_build.sh
        sudo bash ./raphael-rootfs_build.sh "$DISTRO" "$KERNEL_VER"
        
        # æ£€æŸ¥æ„å»ºç»“æœ - æŸ¥æ‰¾åŠ¨æ€ç”Ÿæˆçš„å‹ç¼©åŒ…
        # æŸ¥æ‰¾æ‰€æœ‰.7zæ–‡ä»¶
        7Z_FILES=$(find . -name "*.7z" | grep -v "raphael-rootfs_build.sh" | head -10)
        if [[ -n "$7Z_FILES" ]]; then
          for FILE in $7Z_FILES; do
            FILE_SIZE=$(du -h "$FILE" | cut -f1)
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©: $FILE ($FILE_SIZE)"
            echo "final_filename=$(basename "$FILE")" >> $GITHUB_OUTPUT
            echo "file_path=$FILE" >> $GITHUB_OUTPUT
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            FILE_SIZE_KB=$(du -k "$FILE" | cut -f1)
            FILE_SIZE_GB=$(($FILE_SIZE_KB / 1024 / 1024))
            echo "file_size_gb=$FILE_SIZE_GB" >> $GITHUB_OUTPUT
            break
          done
        else
          echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆä»»ä½•.7zæ–‡ä»¶ï¼"
          ls -la *.7z 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•.7zæ–‡ä»¶"
          exit 1
        fi
        
        # æ£€æŸ¥Booté•œåƒï¼ˆä»…Debian Serverï¼‰
        if [[ "$DISTRO" == "debian-server" && -f "xiaomi-k20pro-boot.img" ]]; then
          echo "âœ… æ‰¾åˆ°Booté•œåƒ: xiaomi-k20pro-boot.img"
          echo "boot_img_exists=true" >> $GITHUB_OUTPUT
        fi
      timeout-minutes: 90

    - name: "ğŸ“¤ ä¸Šä¼ å¤§æ–‡ä»¶åˆ°Artifact"
      if: ${{ steps.build_rootfs.outputs.file_size_gb >= 2 }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build_rootfs.outputs.final_filename }}
        path: ${{ steps.build_rootfs.outputs.file_path }}
        retention-days: 14
        if-no-files-found: error
        compression-level: 0

    - name: "ğŸš€ ç›´æ¥ä¸Šä¼ å°æ–‡ä»¶åˆ°Release"
      if: ${{ !github.event.inputs.skip_release && steps.build_rootfs.outputs.file_size_gb < 2 }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        files: ${{ steps.build_rootfs.outputs.file_path }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸš€ ä¸Šä¼ Booté•œåƒåˆ°Release"
      if: ${{ !github.event.inputs.skip_release && steps.build_rootfs.outputs.boot_img_exists == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        files: xiaomi-k20pro-boot.img
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-release: 
    name: "ğŸ“ æ›´æ–°Releaseä¿¡æ¯"
    runs-on: ubuntu-24.04-arm
    needs: [prepare-release, build-rootfs]
    permissions:
      contents: write
    if: ${{ !github.event.inputs.skip_release && needs.build-rootfs.result == 'success' }}
    steps:
    - name: "ğŸ“ æ›´æ–°Releaseä¿¡æ¯"
      run: |
        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
        echo "### ğŸ“¦ åŒ…å«çš„é•œåƒæ–‡ä»¶" > filelist.md
        echo "" >> filelist.md
        
        # æŸ¥æ‰¾æ‰€æœ‰ä¸Šä¼ åˆ°Releaseçš„å°æ–‡ä»¶ï¼ˆé€šè¿‡GitHub APIï¼‰
        echo "ğŸ” è·å–Releaseèµ„äº§åˆ—è¡¨..."
        gh release view ${{ needs.prepare-release.outputs.release_tag }} --json assets --jq '.assets[].name' > release_assets.txt 2>/dev/null || echo "" > release_assets.txt
        
        # æ·»åŠ å°æ–‡ä»¶åˆ°åˆ—è¡¨
        while read -r asset; do
          if [[ -n "$asset" ]]; then
            echo "- **$asset**" >> filelist.md
          fi
        done < release_assets.txt
        
        # è¯»å–å½“å‰Releaseæè¿°
        CURRENT_BODY=$(gh release view ${{ needs.prepare-release.outputs.release_tag }} --json body --jq '.body')
        
        # æ›´æ–°Releaseæè¿°ï¼Œæ›¿æ¢é•œåƒæ–‡ä»¶éƒ¨åˆ†
        NEW_BODY=$(echo "$CURRENT_BODY" | sed '/### ğŸ“¦ é•œåƒæ–‡ä»¶/,/---/c\### ğŸ“¦ é•œåƒæ–‡ä»¶\n'$(cat filelist.md | sed 's/\//\\\//g' | sed 's/&/\\&/g' | tr '\n' '\n'))
        
        # æ›´æ–°Release
        echo "ğŸ“ æ›´æ–°Releaseä¿¡æ¯..."
        gh release edit ${{ needs.prepare-release.outputs.release_tag }} --body "$NEW_BODY"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}