name: ğŸ§Build RootFS

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (å¯¹åº”Releaseæ ‡ç­¾ï¼Œå¦‚ 6.18)'
        required: true
        default: '6.18'
      build_type:
        description: 'æ„å»ºç±»å‹é€‰æ‹©'
        required: true
        type: choice
        options:
          - all
          - server-only
          - desktop-only
        default: 'all'
      skip_release:
        description: 'è·³è¿‡åˆ›å»ºGitHub Release'
        required: false
        type: boolean
        default: false
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        type: boolean
        default: false
      test_distro:
        description: 'æµ‹è¯•å‘è¡Œç‰ˆ (æµ‹è¯•æ¨¡å¼ä¸‹æœ‰æ•ˆï¼Œå¦‚: debian-server, ubuntu-desktop)'
        required: false
        default: 'debian-server'

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  DEFAULT_KERNEL: '6.18'

jobs:
  build-rootfs:
    name: "ğŸ—ï¸ æ„å»º - ${{ matrix.distro }}"
    runs-on: ubuntu-24.04-arm
    env:
      APT_CACHE_DIR: /opt/apt-cache
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        distro: ${{ 
            github.event.inputs.test_mode == 'true' 
            && fromJSON(format('[{0}]', github.event.inputs.test_distro))
            || github.event.inputs.build_type == 'server-only'
            && fromJSON('["debian-server", "ubuntu-server"]')
            || github.event.inputs.build_type == 'desktop-only'
            && fromJSON('["debian-desktop", "ubuntu-desktop"]')
            || fromJSON('["debian-server", "debian-desktop", "ubuntu-server", "ubuntu-desktop"]')
            }}
      fail-fast: false

    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4

    - name: "ğŸ”§ å®‰è£…æ„å»ºå·¥å…·"
      run: |
        echo "å®‰è£…å¿…éœ€çš„ç³»ç»Ÿå·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap \
          p7zip-full \
          curl
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
        docker rmi -f $(docker images -q) 2>/dev/null || true
        [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
        sudo swapoff -a
        sudo rm -f /swapfile /mnt/swapfile

    - name: "ğŸ“¦ è·å–å†…æ ¸ç‰ˆæœ¬"
      id: kernel_version
      run: |
        # ä¼˜å…ˆçº§ï¼šæ‰‹åŠ¨è¾“å…¥ > Releaseæ ‡ç­¾ > é»˜è®¤å€¼
        if [[ '${{ github.event_name }}' == 'workflow_dispatch' && -n '${{ github.event.inputs.kernel_version }}' ]]; then
          KERNEL_VER='${{ github.event.inputs.kernel_version }}'
          echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        elif [[ '${{ github.ref_type }}' == 'tag' ]]; then
          KERNEL_VER='${GITHUB_REF#refs/tags/}'
          echo "ä½¿ç”¨Tagæ ‡ç­¾ä½œä¸ºå†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        else
          KERNEL_VER='${{ env.DEFAULT_KERNEL }}'
          echo "ä½¿ç”¨é»˜è®¤å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
        fi
        echo "kernel_version=$KERNEL_VER" >> $GITHUB_OUTPUT
        echo "æœ€ç»ˆä½¿ç”¨å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
      shell: bash

    - name: "ğŸ“¥ ä¸‹è½½å†…æ ¸åŒ…"
      id: download_kernel
      run: |
        KERNEL_VER="${{ steps.kernel_version.outputs.kernel_version }}"
        echo "ä» Release [kernel-$KERNEL_VER] ä¸‹è½½å†…æ ¸åŒ…..."
        
        # ä½¿ç”¨GitHub CLIä¸‹è½½Releaseæ–‡ä»¶
        gh release download "kernel-$KERNEL_VER" \
          --pattern "*-xiaomi-raphael*.deb" \
          --repo "${{ github.repository }}" \
          --clobber
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        echo "ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la *.deb 2>/dev/null || echo "æœªæ‰¾åˆ°.debæ–‡ä»¶"
        
        DEB_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        if [ $DEB_COUNT -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæœªä¸‹è½½åˆ°ä»»ä½•å†…æ ¸åŒ…ï¼"
          exit 1
        fi
        
        echo "âœ… æˆåŠŸä¸‹è½½ $DEB_COUNT ä¸ªå†…æ ¸åŒ…"
        echo "deb_count=$DEB_COUNT" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ—ï¸ æ‰§è¡ŒRootFSæ„å»º"
      id: build_rootfs
      run: |
        DISTRO="${{ matrix.distro }}"
        KERNEL_VER="${{ steps.kernel_version.outputs.kernel_version }}"
        
        echo "========================================"
        echo "å¼€å§‹æ„å»º RootFS"
        echo "----------------------------------------"
        echo "å‘è¡Œç‰ˆ: $DISTRO"
        echo "å†…æ ¸: $KERNEL_VER"
        echo "Runner: $(uname -m)"
        echo "æ—¶é—´: $(date)"
        echo "========================================"
        
        # æ£€æŸ¥æ„å»ºè„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "raphael-rootfs_build.sh" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºè„šæœ¬ raphael-rootfs_build.sh"
          exit 1
        fi
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x raphael-rootfs_build.sh
        
        # æ‰§è¡Œæ„å»ºè„šæœ¬
          echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: sudo bash ./raphael-rootfs_build.sh $DISTRO $KERNEL_VER"
          sudo bash ./raphael-rootfs_build.sh "$DISTRO" "$KERNEL_VER"
        
        # æ£€æŸ¥æ„å»ºç»“æœ - æŸ¥æ‰¾åŠ¨æ€ç”Ÿæˆçš„å‹ç¼©åŒ…
        OUTPUT_FILE="raphael-${DISTRO}-kernel-${KERNEL_VER}.7z"
        if [ -f "$OUTPUT_FILE" ]; then
          FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
          echo "âœ… RootFS æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ æ–‡ä»¶: $OUTPUT_FILE"
          echo "ğŸ“ å¤§å°: $FILE_SIZE"
          
          # ä¸ºäº§ç‰©ç”Ÿæˆå”¯ä¸€åç§°
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          NEW_FILENAME="$DISTRO-kernel-$KERNEL_VER-$TIMESTAMP.7z"
          mv "$OUTPUT_FILE" "$NEW_FILENAME"
          
          echo "final_filename=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
        else
          echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆ $OUTPUT_FILE æ–‡ä»¶ï¼"
          ls -la *.7z 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•.7zæ–‡ä»¶"
          exit 1
        fi
      timeout-minutes: 90

    - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.distro }}-${{ steps.kernel_version.outputs.kernel_version }}
        path: |
          ${{ matrix.distro }}-kernel-*.7z
          ${{ startsWith(matrix.distro, 'debian-server') && 'xiaomi-k20pro-boot.img' || '' }}
        retention-days: 14
        if-no-files-found: error
        compression-level: 0  # æ–‡ä»¶å·²å‹ç¼©ï¼Œè·³è¿‡äºŒæ¬¡å‹ç¼©

    - name: "ğŸ“‹ æ„å»ºç»“æœæ‘˜è¦"
      if: always()
      run: |
        echo "========================================"
        echo "æ„å»ºç»“æœæ‘˜è¦ - ${{ matrix.distro }}"
        echo "----------------------------------------"
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "å†…æ ¸ç‰ˆæœ¬: ${{ steps.kernel_version.outputs.kernel_version }}"
        echo "äº§ç‰©: ${{ steps.build_rootfs.outputs.final_filename || 'æœªç”Ÿæˆ' }}"
        echo "å¤§å°: ${{ steps.build_rootfs.outputs.file_size || 'æœªçŸ¥' }}"
        echo "Runner: ${{ runner.os }}-${{ runner.arch }}"
        echo "æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "========================================"

  # å‘å¸ƒReleaseä»»åŠ¡
  create-release:
    name: "ğŸš€ å‘å¸ƒ Release"
    needs: build-rootfs
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    # è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ä¸”ä¸è·³è¿‡å‘å¸ƒï¼Œå¹¶ä¸”æ„å»ºæˆåŠŸ
    if: always()

    
    steps:
    - name: "ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©"
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: '*'
        merge-multiple: true

    - name: "ğŸ” å‡†å¤‡å‘å¸ƒæ–‡ä»¶"
      id: prepare_release
      run: |
        echo "æ•´ç†å‘å¸ƒæ–‡ä»¶..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        RELEASE_DIR="./release-assets"
        LARGE_DIR="./large-assets"
        mkdir -p "$RELEASE_DIR"
        mkdir -p "$LARGE_DIR"
        
        # GitHub Release æ–‡ä»¶å¤§å°é™åˆ¶ (2GB)
        MAX_SIZE=$((2 * 1024 * 1024 * 1024))
        LARGE_FILES=()
        
        # æŸ¥æ‰¾å¹¶ç§»åŠ¨æ‰€æœ‰.7zå’Œ.imgæ–‡ä»¶
        find ./artifacts -type f \( -name "*.7z" -o -name "*.img" \) -exec mv {} "$RELEASE_DIR/" \;
        
        # æ£€æŸ¥è¶…å¤§æ–‡ä»¶å¹¶ç§»è‡³å•ç‹¬ç›®å½•
        for file in "$RELEASE_DIR"/*; do
          if [ -f "$file" ]; then
            SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            if [ "$SIZE" -gt "$MAX_SIZE" ]; then
              echo "âš ï¸  æ–‡ä»¶è¿‡å¤§ï¼Œè·³è¿‡ä¸Šä¼ åˆ°Release: $(basename "$file") ($(($SIZE / 1024 / 1024 / 1024))GB)"
              mv "$file" "$LARGE_DIR/"
              LARGE_FILES+=("$(basename "$file")")
            fi
          fi
        done
        
        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
        echo "### ğŸ“¦ åŒ…å«çš„é•œåƒæ–‡ä»¶" > "$RELEASE_DIR/filelist.md"
        echo "" >> "$RELEASE_DIR/filelist.md"
        
        TOTAL_SIZE=0
        for file in "$RELEASE_DIR"/*; do
          if [ -f "$file" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            SIZE_KB=$(du -k "$file" | cut -f1)
            NAME=$(basename "$file")
            echo "- **$NAME** ($SIZE)" >> "$RELEASE_DIR/filelist.md"
            TOTAL_SIZE=$((TOTAL_SIZE + SIZE_KB))
          fi
        done
        
        # æ·»åŠ è¶…å¤§æ–‡ä»¶è¯´æ˜
        if [ ${#LARGE_FILES[@]} -gt 0 ]; then
          echo "" >> "$RELEASE_DIR/filelist.md"
          echo "---" >> "$RELEASE_DIR/filelist.md"
          echo "### âš ï¸ è¶…å¤§æ–‡ä»¶ (éœ€é€šè¿‡å…¶ä»–æ–¹å¼è·å–)" >> "$RELEASE_DIR/filelist.md"
          for fname in "${LARGE_FILES[@]}"; do
            SIZE=$(du -h "$LARGE_DIR/$fname" | cut -f1)
            echo "- **$fname** ($SIZE) - è¯·ä» Actions Artifacts ä¸‹è½½" >> "$RELEASE_DIR/filelist.md"
          done
        fi
        
        # è®¡ç®—æ€»å¤§å°
        TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024))
        echo "" >> "$RELEASE_DIR/filelist.md"
        echo "**Releaseå†…æ€»è®¡**: $TOTAL_SIZE_MB MB" >> "$RELEASE_DIR/filelist.md"
        
        # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
        FILE_COUNT=$(ls -1 "$RELEASE_DIR"/* 2>/dev/null | wc -l)
        
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "total_size_mb=$TOTAL_SIZE_MB" >> $GITHUB_OUTPUT
        echo "large_files=$(IFS=,; echo "${LARGE_FILES[*]}")" >> $GITHUB_OUTPUT
        
        # è¾“å‡ºæ–‡ä»¶åˆ—è¡¨å†…å®¹åˆ°å˜é‡
        if [ -f "$RELEASE_DIR/filelist.md" ]; then
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "filelist_text<<$EOF" >> $GITHUB_OUTPUT
          cat "$RELEASE_DIR/filelist.md" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
        fi
        
        echo "âœ… æ‰¾åˆ° $FILE_COUNT ä¸ªæ–‡ä»¶ (Releaseå†…)ï¼Œ${#LARGE_FILES[@]} ä¸ªè¶…å¤§æ–‡ä»¶"
        ls -lh "$RELEASE_DIR/"
        if [ ${#LARGE_FILES[@]} -gt 0 ]; then
          echo "è¶…å¤§æ–‡ä»¶å·²ç§»è‡³ $LARGE_DIR:"
          ls -lh "$LARGE_DIR/"
        fi

    - name: "ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾"
      id: generate_tag
      run: |
        # åŸºäºæ—¥æœŸå’Œå†…æ ¸ç‰ˆæœ¬ç”Ÿæˆæ ‡ç­¾
        DATE_TAG=$(date -u '+%Y%m%d')
        KERNEL_REF="${{ github.event.inputs.kernel_version || env.DEFAULT_KERNEL }}"
        SHORT_SHA="${GITHUB_SHA:0:8}"
        
        RELEASE_TAG="rootfs-$DATE_TAG-$KERNEL_REF-$SHORT_SHA"
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "ç‰ˆæœ¬æ ‡ç­¾: $RELEASE_TAG"

    - name: "ğŸš€ åˆ›å»º GitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.release_tag }}
        name: "Ubuntu/Debian for Raphael - ${{ steps.generate_tag.outputs.release_tag }}"
        body: |
          ğŸ§ Ubuntu/Debian for Raphael
          
          --- 
          
          ### ğŸ“‹ æ„å»ºä¿¡æ¯
          | é¡¹ç›® | è¯¦æƒ… |
          |------|------|
          | å†…æ ¸ç‰ˆæœ¬ | ${{ github.event.inputs.kernel_version || env.DEFAULT_KERNEL }} |
          | æ„å»ºSHA | [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
          | æ„å»ºç±»å‹ | ${{ github.event.inputs.build_type || 'all' }} |
          | åŒ…å«å˜ä½“ | ${{ 
              github.event.inputs.test_mode == 'true' && format('{0} (æµ‹è¯•æ¨¡å¼)', github.event.inputs.test_distro) ||
              github.event.inputs.build_type == 'server-only' && 'Debian Server, Ubuntu Server' ||
              github.event.inputs.build_type == 'desktop-only' && 'Debian Desktop, Ubuntu Desktop' ||
              'Debian Server/Desktop, Ubuntu Server/Desktop'
            }} |
          | æ€»å¤§å° | ${{ steps.prepare_release.outputs.total_size_mb }} MB |
          
          ${{ github.event.inputs.test_mode == 'true' && '> âš ï¸ æµ‹è¯•æ¨¡å¼ï¼šä»…æ„å»ºäº†Debian Serverå˜ä½“' || '' }}
          
          --- 
          
          ### ğŸ” é»˜è®¤å‡­æ®
          
          **æœåŠ¡å™¨ç‰ˆ**
          - ç”¨æˆ·å: `root`
          - å¯†ç : `1234` (é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹ï¼)
          
          **æ¡Œé¢ç‰ˆ**
          - ç”¨æˆ·å: `luser`
          - å¯†ç : `luser`
          - è‡ªåŠ¨ç™»å½•: å·²å¯ç”¨
          - æ¡Œé¢ç¯å¢ƒ: GNOME + LightDM
          
          --- 
          
          ### ğŸ›¡ï¸ å®‰å…¨å»ºè®®
          1. é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
          2. ç¦ç”¨rootè¿œç¨‹ç™»å½•ï¼ˆå¯é€‰ï¼‰
          3. é…ç½®é˜²ç«å¢™è§„åˆ™

          --- 
          
          ### ğŸ“¦ é•œåƒæ–‡ä»¶
          ${{ steps.prepare_release.outputs.filelist_text }}

        draft: false
        prerelease: false
        files: |
          release-assets/*.7z
          release-assets/xiaomi-k20pro-boot.img
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ“Š å‘å¸ƒå®Œæˆæ‘˜è¦"
      run: |
        echo "========================================"
        echo "âœ… Release åˆ›å»ºæˆåŠŸï¼"
        echo "----------------------------------------"
        echo "æ ‡ç­¾: ${{ steps.generate_tag.outputs.release_tag }}"
        echo "æ–‡ä»¶: ${{ steps.prepare_release.outputs.file_count }} ä¸ªé•œåƒ"
        echo "å¤§å°: ${{ steps.prepare_release.outputs.total_size_mb }} MB"
        echo "é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ steps.generate_tag.outputs.release_tag }}"
        echo "========================================"