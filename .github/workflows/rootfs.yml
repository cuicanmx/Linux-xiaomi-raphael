name: Build RootFS

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "å†…æ ¸ç‰ˆæœ¬å·"
        required: true
        default: "6.18"
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: "æ„å»ºRootFS"
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        distro: ['debian-server', 'debian-desktop', 'ubuntu-server', 'ubuntu-desktop']
        include:
          - distro: debian-server
            kernel: '6.18'
          - distro: debian-desktop
            kernel: '6.18'
          - distro: ubuntu-server
            kernel: '6.18'
          - distro: ubuntu-desktop
            kernel: '6.18'

    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: "ğŸ”§ å®‰è£…å¿…è¦å·¥å…·"
      run: |
        echo "âš™ï¸ å®‰è£…æ„å»ºå·¥å…·..."
        sudo apt update
        sudo apt install -y debootstrap qemu-user-static binfmt-support p7zip-full
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

    - name: "ğŸ“¦ ä¸‹è½½å†…æ ¸åŒ…"
      run: |
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å†…æ ¸åŒ…..."
        echo "ğŸ”— ä» Release: kernel-${{ matrix.kernel }} ä¸‹è½½"
        
        gh release download kernel-${{ matrix.kernel }} \
          --pattern "*-xiaomi-raphael*.deb" \
          --repo "${{ github.repository }}"
        
        echo "âœ… å†…æ ¸åŒ…ä¸‹è½½å®Œæˆ"
        echo "ğŸ“ å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la *.deb
        
        # Verify downloads
        DEB_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        echo "ğŸ“¦ ä¸‹è½½äº† $DEB_COUNT ä¸ªå†…æ ¸åŒ…"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ—ï¸ æ„å»ºrootfs"
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»º ${{ matrix.distro }} å‘è¡Œç‰ˆ"
        echo "ğŸ“‹ é…ç½®:"
        echo "  - å‘è¡Œç‰ˆ: ${{ matrix.distro }}"
        echo "  - å†…æ ¸ç‰ˆæœ¬: ${{ matrix.kernel }}"
        echo "  - å·¥ä½œç›®å½•: $(pwd)"
        
        echo "âš™ï¸ æ‰§è¡Œæ„å»ºè„šæœ¬..."
        sudo sh raphael-rootfs_build.sh ${{ matrix.distro }} ${{ matrix.kernel }}
        
        echo "âœ… ${{ matrix.distro }} æ„å»ºå®Œæˆ"
      timeout-minutes: 60

    - name: "ğŸ“¤ ä¸Šä¼ äº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.distro }}-${{ matrix.kernel }}
        path: "*.7z"
        retention-days: 7

    - name: "ğŸ“‹ å•ä»»åŠ¡æ€»ç»“"
      if: always()
      run: |
        echo "ğŸ“Š === ä»»åŠ¡ ${{ matrix.distro }} å®Œæˆ ==="
        echo "ğŸ¯ ç›®æ ‡: ${{ matrix.distro }}"
        echo "ğŸ“¦ å†…æ ¸: ${{ matrix.kernel }}"
        echo "ğŸ“ äº§ç‰©: *.7z"
        echo "â±ï¸  çŠ¶æ€: ${{ job.status }}"
        echo "==========================="

  release:
    name: "ğŸ“¦ åˆ›å»ºRelease"
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç "
      uses: actions/checkout@v4

    - name: "ğŸ“¦ ä¸‹è½½æ‰€æœ‰äº§ç‰©"
      run: |
        echo "ğŸ” ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©..."
        
        # Create artifacts directory
        mkdir -p artifacts
        
        # Download all artifacts
        echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©..."
        gh run download ${{ github.run_id }} \
          --repo "${{ github.repository }}" \
          --dir artifacts
        
        echo "âœ… æ‰€æœ‰äº§ç‰©ä¸‹è½½å®Œæˆ"
        echo "ğŸ“ artifactsç›®å½•å†…å®¹:"
        find artifacts -type f -name "*.7z"
        
        ARTIFACT_COUNT=$(find artifacts -type f -name "*.7z" | wc -l)
        echo "ğŸ“¦ å…±æ‰¾åˆ° $ARTIFACT_COUNT ä¸ªrootfsæ–‡ä»¶"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ” æŸ¥æ‰¾å¹¶å¤åˆ¶.7zæ–‡ä»¶"
      run: |
        echo "ğŸ” æŸ¥æ‰¾ .7z æ–‡ä»¶..."
        
        # Find and copy .7z files
        find artifacts -name "*.7z" -type f -exec cp {} . \;
        
        echo "âœ… .7z æ–‡ä»¶å·²å¤åˆ¶åˆ°å½“å‰ç›®å½•"
        
        echo "ğŸ“ å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶:"
        ls -la *.7z
        
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        du -h *.7z
        
        FILE_COUNT=$(ls -1 *.7z 2>/dev/null | wc -l)
        echo "ğŸ“¦ å‡†å¤‡ä¸Šä¼  $FILE_COUNT ä¸ªæ–‡ä»¶"

    - name: "ğŸ·ï¸ åˆ›å»ºRelease"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: rootfs
        name: "RootFS é•œåƒé›†åˆ"
        body: |
          ## RootFS é•œåƒé›†åˆ
          
          ğŸ“… æ„å»ºæ—¶é—´: ${{ github.run_created_at }}
          
          ğŸ–¥ï¸ åŒ…å«ä»¥ä¸‹å‘è¡Œç‰ˆ:
          - Debian Server
          - Debian Desktop (Xfce)
          - Ubuntu Server  
          - Ubuntu Desktop
          
          âš™ï¸ å†…æ ¸ç‰ˆæœ¬: ${{ fromJSON(github.event).inputs.kernel_version || '6.18' }}
          
          ğŸ” é»˜è®¤rootå¯†ç : 1234
          
          ğŸ› è‡ªåŠ¨æ„å»ºäº GitHub Actions
          
          ### æ–‡ä»¶åˆ—è¡¨:
          ${{ steps.find_files.outputs.file_list }}
        draft: false
        prerelease: false
        files: "*.7z"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: "ğŸ“‹ å‘å¸ƒæ€»ç»“"
      if: always()
      run: |
        echo "ğŸ“Š ======== å‘å¸ƒæ€»ç»“ ========"
        echo "ğŸ—ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
        echo "ğŸ¯ Release: rootfs"
        echo "ğŸ“¦ æ–‡ä»¶æ•°é‡: $FILE_COUNT"
        echo "â±ï¸  è¿è¡Œæ—¶é—´: ${{ job.status }}"
        echo "==========================="