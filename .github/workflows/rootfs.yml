# This is a workflow for building rootfs
name: rootfs

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  rootfs:
    # The type of runner that the job will run on
    runs-on: ubuntu-24.04-arm
    strategy:
            matrix:
                distro: [debian-server, debian-desktop, ubuntu-server, ubuntu-desktop]
                kernel: [6.18]
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Download kernel deb packages from release with tag kernel-6.18
      - name: Download Kernel DEB Packages from Release
        run: |
          mkdir -p xiaomi-raphael-debs_${{ matrix.kernel }}
          gh release download kernel-${{ matrix.kernel }} \
            --pattern "*.deb" \
            --dir xiaomi-raphael-debs_${{ matrix.kernel }} \
            --repo ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y debootstrap 7zip kmod tar wget

      - name: Build rootfs
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º ${{ matrix.distro }} å‘è¡Œç‰ˆï¼Œå†…æ ¸ç‰ˆæœ¬ ${{ matrix.kernel }}"
          sudo sh raphael-rootfs_build.sh ${{ matrix.distro }} ${{ matrix.kernel }}
          echo "âœ… ${{ matrix.distro }} æ„å»ºå®Œæˆ"

      - name: Rename rootfs file
        run: |
          echo "ğŸ“ é‡å‘½å rootfs æ–‡ä»¶"
          mv rootfs.7z raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z
          echo "ğŸ“ æ–‡ä»¶å·²é‡å‘½åä¸º: raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z"

      - name: Upload rootfs artifact
        run: |
          echo "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
          ls -la raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z
        
      - name: Upload rootfs artifact
        uses: actions/upload-artifact@v4
        with:
          name: raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z
          path: raphael-${{ matrix.distro }}-${{ matrix.kernel }}.7z
          retention-days: 1

  create-release:
    needs: rootfs
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Download all rootfs artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ğŸ“¥ å·²ä¸‹è½½çš„æ„å»ºäº§ç‰©:"
          ls -la artifacts/
          echo ""
          echo "ğŸ” æ£€æŸ¥äº§ç‰©ç›®å½•ç»“æ„:"
          find artifacts -type f -name "*.7z" | head -10

      - name: Find and copy .7z files
        run: |
          echo "ğŸ” æŸ¥æ‰¾ .7z æ–‡ä»¶"
          find artifacts -name "*.7z" -type f -exec cp {} . \;
          echo "âœ… .7z æ–‡ä»¶å·²å¤åˆ¶åˆ°å½“å‰ç›®å½•"
          
          echo "ğŸ“ å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶:"
          ls -la *.7z
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          du -h *.7z

      - name: Create and Upload RootFS Release
        run: |
          echo "ğŸš€ å‡†å¤‡åˆ›å»º GitHub Release"
          echo "ğŸ·ï¸  Release æ ‡ç­¾: rootfs"
          echo "ğŸ“¦ è¦ä¸Šä¼ çš„æ–‡ä»¶:"
          ls -la *.7z
          echo ""
          echo "ğŸ‘©â€ğŸ’¼ å¼€å§‹åˆ›å»º Release..."
        
      - name: Create and Upload RootFS Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: rootfs
          name: RootFS Build ${{ github.sha }}
          body: |
            RootFS for Xiaomi Raphael with multiple distributions and Kernel ${{ matrix.kernel }}
            
            Built from commit: ${{ github.sha }}
            
            Available distributions:
            - debian-server
            - debian-desktop (Xfce)
            - ubuntu-server
            - ubuntu-desktop
            
            Features:
            - Optimized for Xiaomi Raphael device
            - Includes kernel ${{ matrix.kernel }} and necessary drivers
            - Root password: 1234
          files: "*.7z"
          draft: false
          prerelease: false