name: Build Ubuntu RootFS for Xiaomi Raphael

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (å¯¹åº”Releaseæ ‡ç­¾ï¼Œå¦‚6.18)'
        required: true
        default: '6.18'
      skip_release:
        description: 'è·³è¿‡åˆ›å»ºGitHub Release'
        required: false
        type: boolean
        default: false
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ (ä»…æ„å»ºubuntu-server)'
        required: false
        type: boolean
        default: false
      use_china_mirror:
        description: 'ä½¿ç”¨ä¸­å›½æº'
        required: false
        type: boolean
        default: true

env:
  DEFAULT_KERNEL: '6.18'

jobs:
  setup:
    name: "ç¯å¢ƒå‡†å¤‡"
    runs-on: ubuntu-24.04-arm
    outputs:
      kernel_version: ${{ steps.get_kernel_version.outputs.kernel_version }}
      distro_matrix: ${{ steps.generate_matrix.outputs.distro_matrix }}
    
    steps:
    - name: "æ£€å‡ºä»£ç "
      uses: actions/checkout@v4
    
    - name: "ç¡®å®šå†…æ ¸ç‰ˆæœ¬"
      id: get_kernel_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.kernel_version }}" ]]; then
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
        elif [[ "${{ github.ref_type }}" == "tag" ]]; then
          KERNEL_VER="${GITHUB_REF#refs/tags/}"
        else
          KERNEL_VER="${{ env.DEFAULT_KERNEL }}"
        fi
        
        if [[ ! "$KERNEL_VER" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
          echo "é”™è¯¯ï¼šå†…æ ¸ç‰ˆæœ¬æ ¼å¼æ— æ•ˆ: $KERNEL_VER"
          exit 1
        fi
        
        echo "kernel_version=$KERNEL_VER" >> $GITHUB_OUTPUT
    
    - name: "ç”Ÿæˆå‘è¡Œç‰ˆçŸ©é˜µ"
      id: generate_matrix
      run: |
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          DISTRO_MATRIX='["ubuntu-server"]'
        else
          DISTRO_MATRIX='["ubuntu-server", "ubuntu-desktop"]'
        fi
        echo "distro_matrix=$DISTRO_MATRIX" >> $GITHUB_OUTPUT

  build-rootfs:
    name: "æ„å»º - ${{ matrix.distro }}"
    runs-on: ubuntu-24.04-arm
    needs: setup
    strategy:
      matrix:
        distro: ${{ fromJson(needs.setup.outputs.distro_matrix) }}
      fail-fast: false
    
    steps:
    - name: "æ£€å‡ºä»£ç "
      uses: actions/checkout@v4
    
    - name: "å®‰è£…æ„å»ºå·¥å…·"
      run: |
        sudo apt-get update
        sudo apt-get install -y debootstrap p7zip-full curl
    
    - name: "ä¸‹è½½å†…æ ¸åŒ…"
      id: download_kernel
      run: |
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        RELEASE_TAG="kernel-$KERNEL_VER"
        
        echo "ğŸ“¦ ä»Release [$RELEASE_TAG] ä¸‹è½½å†…æ ¸åŒ…..."
        
        if ! gh release view "$RELEASE_TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°Release [$RELEASE_TAG]"
          exit 1
        fi
        
        gh release download "$RELEASE_TAG" \
          --pattern "*-xiaomi-raphael*.deb" \
          --repo "${{ github.repository }}" \
          --clobber
        
        DEB_COUNT=$(ls -1 *.deb 2>/dev/null | wc -l)
        if [ "$DEB_COUNT" -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæœªä¸‹è½½åˆ°ä»»ä½•å†…æ ¸åŒ…ï¼"
          exit 1
        fi
        
        echo "âœ… å·²ä¸‹è½½ $DEB_COUNT ä¸ªå†…æ ¸åŒ…"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: "ğŸ”§ æ‰§è¡ŒRootFSæ„å»º"
      id: build_rootfs
      timeout-minutes: 120
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»º ${{ matrix.distro }} RootFS..."
        
        DISTRO="${{ matrix.distro }}"
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        
        if [ ! -f "ubuntu-rootfs_build.sh" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºè„šæœ¬ ubuntu-rootfs_build.shï¼"
          exit 1
        fi
        
        chmod +x "ubuntu-rootfs_build.sh"
        
        BUILD_ARGS=("$DISTRO" "$KERNEL_VER")
        if [[ "${{ github.event.inputs.use_china_mirror }}" == "true" ]]; then
          BUILD_ARGS+=("--china-mirror")
          echo "ğŸŒ ä½¿ç”¨ä¸­å›½æºé•œåƒ"
        else
          echo "ğŸŒ ä½¿ç”¨é»˜è®¤é•œåƒæº"
        fi
        
        echo "ğŸ“¦ å¼€å§‹æ‰§è¡Œæ„å»ºè„šæœ¬..."
        sudo "./ubuntu-rootfs_build.sh" "${BUILD_ARGS[@]}"
        
        OUTPUT_PATTERN="${DISTRO}-kernel-${KERNEL_VER}.7z"
        
        if [ -f "$OUTPUT_PATTERN" ]; then
          OUTPUT_FILE="$OUTPUT_PATTERN"
        else
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºäº§ç‰© $OUTPUT_PATTERN"
          ls -la *.7z 2>/dev/null || true
          exit 1
        fi
        
        if [ -f "$OUTPUT_FILE" ]; then
          FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          NEW_FILENAME="${DISTRO}-kernel-${KERNEL_VER}-${BUILD_ID}-${TIMESTAMP}.7z"
          mv "$OUTPUT_FILE" "$NEW_FILENAME"
          
          echo "âœ… æ„å»ºäº§ç‰©: $NEW_FILENAME ($FILE_SIZE)"
          echo "final_filename=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
        else
          echo "âŒ é”™è¯¯ï¼šå¤„ç†æ„å»ºäº§ç‰©æ—¶å‡ºé”™ï¼"
          exit 1
        fi
    
    - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.distro }}-${{ needs.setup.outputs.kernel_version }}
        path: |
          ${{ matrix.distro }}-kernel-*.7z
          xiaomi-k20pro-boot.img
        if-no-files-found: error
        retention-days: 30
        compression-level: 0

  create-release:
    name: "å‘å¸ƒ Release"
    needs: 
      - setup
      - build-rootfs
    runs-on: ubuntu-24.04-arm
    if: |
      github.event.inputs.skip_release != 'true' &&
      needs.build-rootfs.result == 'success'
    
    steps:
    - name: "ä¸‹è½½æ„å»ºäº§ç‰©"
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: '*'
        merge-multiple: true
    
    - name: "å‡†å¤‡å‘å¸ƒæ–‡ä»¶"
      id: prepare_release
      run: |
        RELEASE_DIR="./release"
        mkdir -p "$RELEASE_DIR"
        
        find ./artifacts -type f \( -name "*.7z" -o -name "*.img" \) -exec cp {} "$RELEASE_DIR/" \;
        
        cd "$RELEASE_DIR"
        sha256sum -- * > SHA256SUMS
        
        FILE_COUNT=$(ls -1 *.7z *.img 2>/dev/null | wc -l)
        TOTAL_SIZE=$(du -s . | cut -f1)
        TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024))
        
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "total_size_mb=$TOTAL_SIZE_MB" >> $GITHUB_OUTPUT
    
    - name: "ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾"
      id: generate_tag
      run: |
        DATE_TAG=$(date -u '+%Y%m%d')
        KERNEL_VER="${{ needs.setup.outputs.kernel_version }}"
        SHORT_SHA="${GITHUB_SHA:0:7}"
        
        RELEASE_TAG="ubuntu-rootfs-$DATE_TAG-$KERNEL_VER-$SHORT_SHA"
        echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
    
    - name: "åˆ›å»º GitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.release_tag }}
        name: "Ubuntu for Raphael - ${{ steps.generate_tag.outputs.release_tag }}"
        body: |
          # Ubuntu for Xiaomi Raphael (K20 Pro)
          
          ## æ„å»ºä¿¡æ¯
          - **å†…æ ¸ç‰ˆæœ¬**: ${{ needs.setup.outputs.kernel_version }}
          - **æ„å»ºSHA**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **æ„å»ºæ—¶é—´**: ${{ github.event.created_at }}
          - **æ€»å¤§å°**: ${{ steps.prepare_release.outputs.total_size_mb }} MB
          
          ${{ github.event.inputs.test_mode == 'true' && '> æµ‹è¯•æ¨¡å¼ï¼šä»…æ„å»ºäº†Ubuntu Serverå˜ä½“' || '' }}
          
          ## é»˜è®¤å‡­æ®
          - **ç”¨æˆ·å**: `root`
          - **å¯†ç **: `1234`
          
          ## æ–‡ä»¶åˆ—è¡¨
          ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c SHA256SUMS
          ```
        draft: false
        prerelease: false
        files: |
          release/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
